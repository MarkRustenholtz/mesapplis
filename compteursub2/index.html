<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>CR Gendarmerie</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#2c3e50">
<link rel="apple-touch-icon" href="icon-192.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

<style>
body {
  font-family: verdana, sans-serif;
  margin: 0;
  padding: 0;
  background: #f0f2f5;
  overflow-x: hidden;
  color: #222;
  min-height: 100vh;
  box-sizing: border-box;
  touch-action: manipulation;
}

h1, h2, h3 { 
  text-align: center;
  color: #2c3e50;
}

/* Boutons unifiés */
button {
  cursor: pointer;
  font-weight: bold;
  border: none;
  border-radius: 6px;
  padding: 8px 12px;
  font-size: 1em;
  margin: 4px 2px;
  min-width: 36px;
  min-height: 36px;
  user-select: none;
  transition: background-color 0.2s ease;
  display: inline-flex;
  align-items: center;
  gap: 6px;
}

/* Boutons plus/minus plus gros comme Border Force */
button.plusminus {
  width: 50px;
  height: 50px;
  border-radius: 10px;
  font-size: 1.6em;
  background-color: #f0f0f0;
  min-width: 50px;
  min-height: 50px;
}

button.plusminus:hover { 
  background-color: #ddd; 
}

button.plusminus.minus {
  background-color: #e74c3c;
  color: white;
}
button.plusminus.minus:hover {
  background-color: #c0392b;
}

button.plusminus.plus {
  background-color: #3498db;
  color: white;
}
button.plusminus.plus:hover {
  background-color: #2980b9;
}

button.add {
  background-color: #27ae60;
  color: white;
}
button.add:hover {
  background-color: #229954;
}

button.red {
  background-color: #e74c3c; 
  color: white; 
}
button.red:hover { 
  background-color: #c0392b; 
}

button.blue {
  background-color: #3498db; 
  color: white; 
}
button.blue:hover { 
  background-color: #2980b9; 
}

button.green {
  background-color: #27ae60; 
  color: white; 
}
button.green:hover { 
  background-color: #229954; 
}

/* Pages */
.page {
  display: none;
  min-height: 100vh;
  background: #f0f2f5;
}

.page.active {
  display: block;
}

/* Page d'accueil */
.home-page {
  display: flex;
  flex-direction: column;
  min-height: 100vh;
  text-align: center;
  padding: 20px;
}
/* Page d'accueil : occupe tout l'écran sans scroll */
#homePage {
  width: 100vw;       /* pleine largeur écran */
  height: 100vh;      /* pleine hauteur écran */
   overflow-y: auto;    /* autorise le scroll vertical */
  overflow-x: hidden;  /* évite le scroll horizontal */
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}
.home-title {
  color: white;
  background-color: #003366;
  padding: 20px;
  margin: 0 -10px 30px -10px;
  border-radius: 0;
  font-size: 1.5em;
  text-align: center;
}

.home-menu {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 20px;
  justify-items: center;
  margin-top: 20px;
}

.icon-button {
  display: inline-flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  width: 120px;
  height: 120px;
  border-radius: 20px;
  background: #ffffff;
  box-shadow: 0 4px 8px rgba(0,0,0,0.2);
  cursor: pointer;
  transition: transform 0.2s ease, box-shadow 0.2s ease;
  border: none;
  font-family: inherit;
}

.icon-button:hover {
  transform: scale(1.05);
  box-shadow: 0 6px 12px rgba(0,0,0,0.3);
}

.icon-button i {
  font-size: 40px;
  margin-bottom: 8px;
}

.icon-button span {
  font-size: 14px;
  font-weight: bold;
  color: #333;
  text-align: center;
}

/* Couleurs icônes */
.icon-esr i { color: #2ecc71; }
.icon-compteurs i { color: #9b59b6; }
.icon-fiche i { color: #e74c3c; }
.icon-visa i { color: #0055A4; }
.icon-cr i { color: #27ae60; }
.icon-infosite i { color: #3498db; }

/* En-tête de page unifié */
.page-header {
  display: flex;
  align-items: center;
  background-color: #003366;
  color: white;
  padding: 10px;
  border-radius: 0;
  margin-bottom: 20px;
}

.back-button {
  background: white;
  color: #003366;
  border: none;
  border-radius: 6px;
  padding: 6px 10px;
  font-weight: bold;
  cursor: pointer;
  margin-right: 10px;
}

.back-button:hover {
  background: #f0f0f0;
}

.page-title {
  flex: 1;
  text-align: center;
  font-size: 1.2em;
  font-weight: bold;
}

#ficheIdentiteApp h2,
#assistantVisaApp h2 {
  background-color: #003366;
  color: white;
  padding: 12px 15px;
  margin: 20px -15px 15px -15px;
  border-radius: 0;
  text-align: center;
}

.page-content {
  padding: 15px;
  background: #f0f2f5;
  border-radius: 8px;
}

/* Formulaires */
label {
  display: block;
  margin: 6px 0 3px 0;
  font-weight: 500;
}

input[type=text], input[type=date], input[type=time], input[type=number], select {
  width: 100%;
  padding: 8px 10px;
  box-sizing: border-box;
  border-radius: 6px;
  border: 1px solid #ddd;
  font-size: 1em;
  margin-bottom: 8px;
}

textarea {
  width: 100%;
  min-height: 80px;
  font-family: monospace;
  font-size: 1em;
  padding: 8px;
  box-sizing: border-box;
  border-radius: 4px;
  border: 1px solid #ccc;
  resize: vertical;
}

/* Section informations */
.info-section {
  border: 2px solid #28a745;
  border-radius: 10px;
  padding: 15px;
  margin-bottom: 20px;
  background: #f8fff9;
}

.info-row {
  display: flex;
  gap: 15px;
  flex-wrap: wrap;
  align-items: center;
  margin-bottom: 10px;
}

.info-input {
  width: 150px;
  font-size: 1em;
  padding: 4px 6px;
}

#selectSite {
  font-size: 1em;
  padding: 4px 6px;
  margin-bottom: 15px;
}

/* Cartes de véhicules plus grandes */
.vehicle-card {
  border: 2px solid #3498db;
  border-radius: 10px;
  padding: 20px;
  margin-bottom: 20px;
  background: #f8f9fa;
  min-height: 120px;
}

.vehicle-card h3 {
  font-size: 1.3em;
  margin-top: 0;
  margin-bottom: 15px;
  color: #2c3e50;
}

.flex-row {
  display: flex;
  flex-direction: column;   /* empile les lignes */
  align-items: center;      /* centre les compteurs */
  gap: 12px;
  margin-bottom: 15px;
}

.flex-row > div {
  display: flex;
  justify-content: center;  /* centre horizontalement le contenu */
  align-items: center;
  gap: 8px;
}

/* Sauf pour les labels "Ajouter manuellement" -> alignés à gauche */
.flex-row > div label {
  justify-content: flex-start;
  text-align: left;
  width: 100%;  /* prend toute la largeur de la carte */
}

/* Compteurs plus visibles */
span[id$="Count"] {
  font-size: 1.2em;
  font-weight: bold;
  margin: 0 10px;
}

.manual-input {
  width: 80px;
  font-size: 1em;
  padding: 4px 6px;
}

.small-note {
  font-size: 0.85em;
  color: #666;
  margin-top: 5px;
  margin-bottom: 15px;
}

/* QR Code */
#qrcode {
  display: flex;
  justify-content: center;
  align-items: center;
  margin-top: 20px;
}

#qrcode img {
  display: block;
}

/* Fiche Identité */
#ficheIdentitePage h2 {
  background-color: #003366 !important;
  color: white !important;
  padding: 12px 15px;
  margin: 20px -15px 15px -15px;
  border-radius: 0;
  text-align: center;
}

/* Assistant Visa */
.autocomplete-container {
  position: relative;
  width: 100%;
}

#paysInput {
  width: 100%;
  padding: 8px;
  border: 1px solid #ccc;
  border-radius: 4px;
  font-size: 16px;
}

#paysDropdown {
  position: absolute;
  top: 100%;
  left: 0;
  right: 0;
  background: white;
  border: 1px solid #ccc;
  border-top: none;
  border-radius: 0 0 4px 4px;
  max-height: 200px;
  overflow-y: auto;
  z-index: 1000;
  display: none;
}

.pays-option {
  padding: 10px;
  cursor: pointer;
  border-bottom: 1px solid #eee;
}

.pays-option:hover, .pays-option.selected {
  background-color: #0055A4;
  color: white;
}

.pays-option:last-child {
  border-bottom: none;
}

#resultat {
  margin-top: 15px;
  font-weight: bold;
}

/* Responsive */
@media (max-width: 768px) {
  .icon-button {
    width: 100px;
    height: 100px;
  }
  
  .icon-button i {
    font-size: 32px;
  }

  .icon-button span {
    font-size: 12px;
  }

  .vehicle-card {
    padding: 15px;
  }

  .plusminus {
    width: 45px;
    height: 45px;
    font-size: 1.4em;
  }
}
  .selected-site {
  margin: 15px auto;
  padding: 10px 15px;
  background: #003366;
  color: white;
  border-radius: 8px;
  display: inline-block;
  font-weight: bold;
}

.site-list {
  display: flex;
  flex-direction: column;
  gap: 15px;
  margin-top: 20px;
}

.site-btn {
  padding: 15px;
  background: #fff;
  border: 2px solid #003366;
  border-radius: 10px;
  font-size: 1.2em;
  font-weight: bold;
  color: #003366;
  text-align: center;
  transition: all 0.2s ease;
}

.site-btn:hover,
.site-btn:active {
  background: #003366;
  color: #fff;
}
 /* Empêche le zoom automatique sur iOS */
  @supports (-webkit-touch-callout: none) {
    input[type=text], input[type=date], input[type=time], input[type=number], select {
      font-size: 16px;
    }
  }

</style>
</head>
<body>

<div id="homePage" class="page active">
  <h1 class="home-title">GENDARMERIE<br> Moyens / Personnes</h1>
  <div class="home-menu">
   <button class="icon-button icon-infosite" onclick="showPage('infositePage')">
      <i class="fas fa-map-marker-alt gps-pin"></i>
      <span>SITE</span>
    </button>
     <button class="icon-button icon-esr" onclick="showPage('esrPage')">
      <i class="fas fa-user-shield"></i>
      <span>ESR</span>
    </button>
    <button class="icon-button icon-compteurs" onclick="showPage('vehiculesPage')">
      <i class="fas fa-chart-bar"></i>
      <span>Compteurs</span>
    </button>
     <button class="icon-button icon-fiche" onclick="showPage('ficheIdentitePage')">
      <i class="fas fa-id-card"></i>
      <span>Fiche identité</span>
    </button>
    <button class="icon-button icon-visa" onclick="showPage('assistantVisaPage')">
      <i class="fas fa-passport"></i>
      <span>Assistant Visas</span>
    </button>
	<button class="icon-button icon-cr" onclick="showPage('crPage')">
      <i class="fas fa-file-alt"></i>
      <span>Compte Rendu</span>
    </button>
  </div>
</div>

<!-- PAGE SITE de Mission -->
<div id="infositePage" class="page">
  <div class="page-header">
    <button class="back-button" onclick="showPage('homePage')">
      <i class="fas fa-arrow-left"></i> Retour
    </button>
    <div class="page-title">Site de mission</div>
  </div>

  <section class="infosite">
  <div class="page-content" style="text-align:center;">
       <h3>Choisir un site</h3>
	   <div id="selectedSiteDisplay" class="selected-site"></div>
    <div class="site-list">
      <button class="site-btn" onclick="selectSite('Breil')">Breil</button>
      <button class="site-btn" onclick="selectSite('La Turbie')">La Turbie</button>
      <button class="site-btn" onclick="selectSite('DSI Tende')">DSI Tende</button>
    </div>
  </div> 
	</section>
	</div>
	
<!-- PAGE ESR -->
<div id="esrPage" class="page">
  <div class="page-header">
    <button class="back-button" onclick="showPage('homePage')">
      <i class="fas fa-arrow-left"></i> Retour </button>
    <div class="page-title">Infos ESR</div>
  </div>

  <section class="info-section">
    <h3 style="margin-top:0; color:#2c3e50;">Informations personnelles</h3>
    <div class="info-row">
      <label>Grade : 
        <input type="text" id="grade" class="info-input" placeholder="Entrez votre grade">
      </label>
      <label>Nom Prénom : 
        <input type="text" id="nomPrenom" class="info-input" placeholder="Entrez nom prénom">
      </label>
    </div>
    <div class="info-row">
      <label>Nigend : 
        <input type="text" id="nigend" class="info-input" placeholder="Entrez Nigend">
      </label>
      <label>CRT : 
        <input type="text" id="crt" class="info-input" placeholder="Entrez CRT">
      </label>
    </div>
    <div style="text-align:center; margin-top:15px;">
      <button id="validerInfos" class="green">Valider les informations</button>
      <button id="resetInfosBtn" class="red">Effacer les informations</button>
    </div>
  </section>
</div>

<!-- Page Véhicules/Compteurs -->
<div id="vehiculesPage" class="page">
  <div class="page-header">
    <button class="back-button" onclick="showPage('homePage')">
      <i class="fas fa-arrow-left"></i> Retour
    </button>
    <div class="page-title">Moyens / Personnes contrôlées</div>
  </div>
  <div class="page-content">
    <div class="vehicle-card" id="trainCard">
      <h3>Train</h3>
      <div class="flex-row" style="align-items:center;">
        <div>
          <button class="plusminus minus" data-type="train" data-field="vehicules" data-action="minus">-</button>
          <span id="trainVehiclesCount">0</span> véhicules
          <button class="plusminus plus" data-type="train" data-field="vehicules" data-action="plus">+</button>
        </div>
        <div style="margin-left:20px;">
          <button class="plusminus minus" data-type="train" data-field="cv" data-action="minus">-</button>
          <span id="trainCvCount">0</span> CV
          <button class="plusminus plus" data-type="train" data-field="cv" data-action="plus">+</button>
        </div>
        <div>
          <label style="margin-left:15px;">Ajouter CV manuellement:
            <input type="number" id="trainCvManual" class="manual-input" min="0" placeholder="0" inputmode="numeric" pattern="[0-9]*">
            <button id="trainCvAddManualBtn" class="add">Ajouter</button>
          </label>
        </div>
        <div style="margin-left:20px;">
          <button class="plusminus minus" data-type="train" data-field="cf" data-action="minus">-</button>
          <span id="trainCfCount">0</span> CF
          <button class="plusminus plus" data-type="train" data-field="cf" data-action="plus">+</button>
        </div>
        <div>
          <label style="margin-left:15px;">Ajouter CF manuellement:
            <input type="number" id="trainCfManual" class="manual-input" min="0" placeholder="0" inputmode="numeric" pattern="[0-9]*">
            <button id="trainCfAddManualBtn" class="add">Ajouter</button>
          </label>
        </div>
      </div>
    </div>

    <div class="vehicle-card" id="busCard">
      <h3>Bus</h3>
      <div class="flex-row" style="align-items:center;">
        <div>
          <button class="plusminus minus" data-type="bus" data-field="vehicules" data-action="minus">-</button>
          <span id="busVehiclesCount">0</span> véhicules
          <button class="plusminus plus" data-type="bus" data-field="vehicules" data-action="plus">+</button>
        </div>
        <div style="margin-left:20px;">
          <button class="plusminus minus" data-type="bus" data-field="cv" data-action="minus">-</button>
          <span id="busCvCount">0</span> CV
          <button class="plusminus plus" data-type="bus" data-field="cv" data-action="plus">+</button>
        </div>
        <div>
          <label style="margin-left:15px;">Ajouter CV manuellement:
            <input type="number" id="busCvManual" class="manual-input" min="0" placeholder="0" inputmode="numeric" pattern="[0-9]*">
            <button id="busCvAddManualBtn" class="add">Ajouter</button>
          </label>
        </div>
        <div style="margin-left:20px;">
          <button class="plusminus minus" data-type="bus" data-field="cf" data-action="minus">-</button>
          <span id="busCfCount">0</span> CF
          <button class="plusminus plus" data-type="bus" data-field="cf" data-action="plus">+</button>
        </div>
        <div>
          <label style="margin-left:15px;">Ajouter CF manuellement:
            <input type="number" id="busCfManual" class="manual-input" min="0" placeholder="0" inputmode="numeric" pattern="[0-9]*">
            <button id="busCfAddManualBtn" class="add">Ajouter</button>
          </label>
        </div>
      </div>
    </div>

    <div class="vehicle-card" id="vlCard">
      <h3>VL</h3>
      <div class="flex-row" style="align-items:center;">
        <div>
          <button class="plusminus minus" data-type="vl" data-field="vehicules" data-action="minus">-</button>
          <span id="vlVehiclesCount">0</span> véhicules
          <button class="plusminus plus" data-type="vl" data-field="vehicules" data-action="plus">+</button>
        </div>
        <div style="margin-left:20px;">
          <button class="plusminus minus" data-type="vl" data-field="cv" data-action="minus">-</button>
          <span id="vlCvCount">0</span> CV
          <button class="plusminus plus" data-type="vl" data-field="cv" data-action="plus">+</button>
        </div>
        <div>
          <label style="margin-left:15px;">Ajouter CV manuellement:
            <input type="number" id="vlCvManual" class="manual-input" min="0" placeholder="0" inputmode="numeric" pattern="[0-9]*">
            <button id="vlCvAddManualBtn" class="add">Ajouter</button>
          </label>
        </div>
        <div style="margin-left:20px;">
          <button class="plusminus minus" data-type="vl" data-field="cf" data-action="minus">-</button>
          <span id="vlCfCount">0</span> CF
          <button class="plusminus plus" data-type="vl" data-field="cf" data-action="plus">+</button>
        </div>
        <div>
          <label style="margin-left:15px;">Ajouter CF manuellement:
            <input type="number" id="vlCfManual" class="manual-input" min="0" placeholder="0" inputmode="numeric" pattern="[0-9]*">
            <button id="vlCfAddManualBtn" class="add">Ajouter</button>
          </label>
        </div>
      </div>
    </div>

    <div class="vehicle-card" id="plCard">
      <h3>PL</h3>
      <div class="flex-row" style="align-items:center;">
        <div>
          <button class="plusminus minus" data-type="pl" data-field="vehicules" data-action="minus">-</button>
          <span id="plVehiclesCount">0</span> véhicules
          <button class="plusminus plus" data-type="pl" data-field="vehicules" data-action="plus">+</button>
        </div>
        <div style="margin-left:20px;">
          <button class="plusminus minus" data-type="pl" data-field="cv" data-action="minus">-</button>
          <span id="plCvCount">0</span> CV
          <button class="plusminus plus" data-type="pl" data-field="cv" data-action="plus">+</button>
        </div>
        <div>
          <label style="margin-left:15px;">Ajouter CV manuellement:
            <input type="number" id="plCvManual" class="manual-input" min="0" placeholder="0" inputmode="numeric" pattern="[0-9]*">
            <button id="plCvAddManualBtn" class="add">Ajouter</button>
          </label>
        </div>
        <div style="margin-left:20px;">
          <button class="plusminus minus" data-type="pl" data-field="cf" data-action="minus">-</button>
          <span id="plCfCount">0</span> CF
          <button class="plusminus plus" data-type="pl" data-field="cf" data-action="plus">+</button>
        </div>
        <div>
          <label style="margin-left:15px;">Ajouter CF manuellement:
            <input type="number" id="plCfManual" class="manual-input" min="0" placeholder="0" inputmode="numeric" pattern="[0-9]*">
            <button id="plCfAddManualBtn" class="add">Ajouter</button>
          </label>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Page Fiche identité (intégration ESI+Visa - partie Fiche) -->
<div id="ficheIdentitePage" class="page">
  <div class="page-header">
    <button class="back-button" onclick="showPage('homePage')">
      <i class="fas fa-arrow-left"></i> Retour
    </button>
    <div class="page-title">Fiche identité</div>
  </div>
  <div class="page-content">
    <!-- Ici on intégrera le formulaire complet ESI (prochaine étape) -->
    <div id="ficheIdentiteApp">
  <form id="ficheForm">
    <label>Catégorie :
      <select id="categorie">
        <option value="ESI">ESI</option>
        <option value="PASSEUR">PASSEUR</option>
      </select>
    </label>

    <h2>Identité</h2>
    <label>Nom<input type="text" id="nom" autocomplete="off" required></label>
    <label>Prénom<input type="text" id="prenom" autocomplete="off" required></label>
    <label>Sexe
      <select id="sexe">
        <option value="">--Sélectionner--</option>
        <option value="Masculin">Masculin</option>
        <option value="Féminin">Féminin</option>
        <option value="Autre">Autre</option>
      </select>
    </label>
    <label>Nationalité<input type="text" id="nationalite" autocomplete="off"></label>

    <label>Date de naissance :</label>
    <div class="date-naissance">
      <input type="number" id="jour" placeholder="JJ" min="1" max="31" required>
      <input type="number" id="mois" placeholder="MM" min="1" max="12" required>
      <input type="number" id="annee" placeholder="AAAA" min="1900" max="2100" required>
    </div>
    <label>Âge<input type="number" id="age" readonly></label>

    <h2>Intervention</h2>
    <label>Heure et Date d'intervention :</label>
    <div class="heure-date">
      <input type="time" id="heure" required>
      <input type="date" id="dateIntervention" required>
    </div>
    <label>Lieu d'interpellation<input type="text" id="lieuInterpellation" autocomplete="off"></label>
    <label>Suites données<input type="text" id="suitesDonnees" autocomplete="off"></label>

    <h2>Voyage</h2>
    <label>Ville de départ<input type="text" id="villeDepart" autocomplete="off"></label>
    <label>Pays de départ<input type="text" id="paysDepart" autocomplete="off"></label>
    <label>Ville de destination<input type="text" id="villeDestination" autocomplete="off"></label>
    <label>Pays de destination<input type="text" id="paysDestination" autocomplete="off"></label>

    <h2>Véhicule</h2>
    <label>Type de véhicule<input type="text" id="vehicule" autocomplete="off"></label>
    <label>Immatriculation<input type="text" id="immatriculation" autocomplete="off"></label>

    <h2>Pièces d'identité présentées</h2>
    <div id="piecesIdentite">
      <label><input type="checkbox" name="piece" value="Passeport valide"> Passeport valide</label>
      <label><input type="checkbox" name="piece" value="Passeport périmé"> Passeport périmé</label>
      <label><input type="checkbox" name="piece" value="Fiche de demande d'asile valide"> Fiche de demande d'asile valide</label>
      <label><input type="checkbox" name="piece" value="Fiche de demande d'asile périmée"> Fiche de demande d'asile périmée</label>
      <label><input type="checkbox" name="piece" value="Carte d'identité valide"> Carte d'identité valide</label>
      <label><input type="checkbox" name="piece" value="Carte d'identité périmée"> Carte d'identité périmée</label>
      <label><input type="checkbox" name="piece" value="Titre de séjour valide"> Titre de séjour valide</label>
      <label><input type="checkbox" name="piece" value="Titre de séjour périmé"> Titre de séjour périmé</label>
      <label><input type="checkbox" id="autreCheck" name="piece" value=""> Autre :</label>
    </div>
    <input type="text" id="autreTexte" placeholder="Précisez..." style="width:100%;margin-top:5px;padding:8px;" disabled>

    <button type="submit" class="blue">Enregistrer la fiche</button>

  </form>

  <h2>Historique des fiches</h2>
  <div id="historique"></div>
  <button id="effacerFiches" class="red">Effacer toutes les fiches</button>
</div>

  </div>
</div>

<!-- Page Assistant Visas (intégration ESI+Visa - partie Assistant) -->
<div id="assistantVisaPage" class="page">
  <div class="page-header">
    <button class="back-button" onclick="showPage('homePage')">
      <i class="fas fa-arrow-left"></i> Retour
    </button>
    <div class="page-title">Assistant Visas</div>
  </div>
  <div class="page-content">
    <!-- Ici on intégrera l'Assistant Visa France (prochaine étape) -->
    <div id="assistantVisaApp">
  <h2>Mini Assistant Visa France</h2>
  <label for="paysInput">Sélectionnez votre pays :</label><br>
  <div class="autocomplete-container">
    <input type="text" id="paysInput" placeholder="Tapez le nom du pays..." autocomplete="off">
    <div id="paysDropdown"></div>
  </div><br>

  <label for="duree">Type de séjour :</label><br>
  <select id="duree">
    <option value="court">Courte durée (&lt;90 jours)</option>
    <option value="long">Longue durée (&gt;90 jours)</option>
  </select><br>

  <p id="resultat"></p>
  
  
  <p>LIENS UTILES:</p> <a href="https://www.visa-schengen.info/voyager-en-europe/pays-exemptes/" target="blank">Pays exemptés de visas</a><br><br>
                <a href="https://www.visa-schengen.info/voyager-en-europe/pays-concernes/" target="blank">Pays concernés</a><br><br>
				<a href="https://www.immigration.interieur.gouv.fr/fr/Immigration/Les-visas" target="blank">Les visas/immigration</a>   
							
</div>

  </div>
</div>

<div id="crPage" class="page">
  <div class="page-header">
    <button class="back-button" onclick="showPage('homePage')">
      <i class="fas fa-arrow-left"></i> Retour
    </button>
    <div class="page-title">Compte rendu</div>
  </div>
  
  <section style="text-align:center; margin-bottom:20px;">
   
  <button id="generateBtn" class="blue">Générer compte rendu</button>
  <button id="transmettreBtn" class="green">TRANSMETTRE</button>
</section>

<div id="qrcode"></div>

<section>
  <h2>Compte rendu généré :</h2>
  <textarea id="compteRendu" readonly rows="12" style="font-family:monospace; white-space:pre-wrap;"></textarea>
</section>
<section style="text-align:center; margin-top:30px;">
    <button id="resetBtn" class="red">Effacer les données sauvegardées</button>
	</section>
</div>
  
<script>
(() => {
  const state = {
    vehicules:{train:0,bus:0,vl:0,pl:0},
    cv:{train:0,bus:0,vl:0,pl:0},
    cf:{train:0,bus:0,vl:0,pl:0},
    infos:{grade:'', nomPrenom:'', nigend:'', crt:''}
  };
  let saveTimeout=null, crGenere=false, infosValidees=false;

  function debounceSave(){
    if(saveTimeout) clearTimeout(saveTimeout);
    saveTimeout = setTimeout(()=>{
      localStorage.setItem('moyensData', JSON.stringify({
        vehicules: state.vehicules,
        cv: state.cv,
        cf: state.cf
      }));
      localStorage.setItem('infosPersonnelles', JSON.stringify(state.infos));
    },3000);
  }

  function updateUI(){
    ['train','bus','vl','pl'].forEach(t=>{
      if(document.getElementById(t+'VehiclesCount'))
        document.getElementById(t+'VehiclesCount').textContent = state.vehicules[t];
      if(document.getElementById(t+'CvCount'))
        document.getElementById(t+'CvCount').textContent = state.cv[t];
      if(document.getElementById(t+'CfCount'))
        document.getElementById(t+'CfCount').textContent = state.cf[t];
    });
  }

  function changeCount(type,field,action){
    if(action==='plus') state[field][type]++;
    else if(state[field][type]>0) state[field][type]--;
    updateUI();
    debounceSave();
  }

  // CV
function addManualCv(type){
  const input = document.getElementById(type+'CvManual');
  if(!input) return;
  const val = parseInt(input.value, 10);
  if (!(val > 0)) { alert('Veuillez saisir un nombre entier > 0.'); input.focus(); input.select(); return; }
  state.cv[type] += val;
  updateUI(); debounceSave();
  input.value = '';          // ← vide
  input.placeholder = '0';   // ← indicatif
  input.blur();              // (optionnel)
}

// CF
function addManualCf(type){
  const input = document.getElementById(type+'CfManual');
  if(!input) return;
  const val = parseInt(input.value, 10);
  if (!(val > 0)) { alert('Veuillez saisir un nombre entier > 0.'); input.focus(); input.select(); return; }
  state.cf[type] += val;
  updateUI(); debounceSave();
  input.value = '';
  input.placeholder = '0';
  input.blur();
}


  
  function generateCR(){
    let cr = '';
    ['train','bus','vl','pl'].forEach(t=>{
      cr += `${t.charAt(0).toUpperCase()+t.slice(1)}: ${state.vehicules[t]} / ${state.cv[t]} CV / ${state.cf[t]} CF\n`;
    });
    const totalVehicules = ['train','bus','vl','pl'].reduce((a,t)=>a+state.vehicules[t],0);
    const totalPersonnes = ['train','bus','vl','pl'].reduce((a,t)=>a+state.cv[t]+state.cf[t],0);
    cr += `\nTOTAL MOYENS : ${totalVehicules}\nTOTAL PERSONNES : ${totalPersonnes}`;
    if(document.getElementById('compteRendu'))
      document.getElementById('compteRendu').value = cr;
    crGenere = true;
  }

  function saveInfos(){
    state.infos.grade = document.getElementById('grade')?.value.trim() || '';
    state.infos.nomPrenom = document.getElementById('nomPrenom')?.value.trim() || '';
    state.infos.nigend = document.getElementById('nigend')?.value.trim() || '';
    state.infos.crt = document.getElementById('crt')?.value.trim() || '';
    localStorage.setItem('infosPersonnelles', JSON.stringify(state.infos));
  }

  function loadInfos(){
    if(document.getElementById('grade')) document.getElementById('grade').value = state.infos.grade;
    if(document.getElementById('nomPrenom')) document.getElementById('nomPrenom').value = state.infos.nomPrenom;
    if(document.getElementById('nigend')) document.getElementById('nigend').value = state.infos.nigend;
    if(document.getElementById('crt')) document.getElementById('crt').value = state.infos.crt;
  }

  function disableInfos(disable){
    ['grade','nomPrenom','nigend','crt','validerInfos'].forEach(id=>{
      if(document.getElementById(id)) document.getElementById(id).disabled = disable;
    });
  }

  // Charger sauvegardes
  const savedData = localStorage.getItem('moyensData');
  if(savedData){
    try{
      const parsed = JSON.parse(savedData);
      state.vehicules = parsed.vehicules || state.vehicules;
      state.cv = parsed.cv || state.cv;
      state.cf = parsed.cf || state.cf;
    }catch(e){}
  }
  const savedInfos = localStorage.getItem('infosPersonnelles');
  if(savedInfos){
    try{ state.infos = JSON.parse(savedInfos); }catch(e){}
  }

  if(state.infos.grade||state.infos.nomPrenom||state.infos.nigend||state.infos.crt){
    infosValidees=true;
    disableInfos(true);
  }

  updateUI();
  loadInfos();

  // Boutons plus/minus
  document.querySelectorAll('button.plusminus').forEach(b=>
    b.addEventListener('click',()=>changeCount(b.dataset.type,b.dataset.field,b.dataset.action))
  );
  ['train','bus','vl','pl'].forEach(t=>{
    if(document.getElementById(t+'CvAddManualBtn'))
      document.getElementById(t+'CvAddManualBtn').addEventListener('click',()=>addManualCv(t));
  });
['train','bus','vl','pl'].forEach(t=>{
  if(document.getElementById(t+'CfAddManualBtn'))
    document.getElementById(t+'CfAddManualBtn').addEventListener('click',()=>addManualCf(t));
});
['train','bus','vl','pl'].forEach(t=>{
  ['Cv','Cf'].forEach(kind=>{
    const inp = document.getElementById(`${t}${kind}Manual`);
    if(!inp) return;

    inp.addEventListener('focus', () => {
      if (inp.value === '0') inp.value = '';
      if (inp.value) inp.select();
    });

    const btn = document.getElementById(`${t}${kind}AddManualBtn`);
    if(btn){
      inp.addEventListener('keydown', (e)=>{
        if(e.key === 'Enter') btn.click();
      });
    }
  });
});
  // Boutons Compte rendu
  if (document.getElementById('generateBtn'))
    document.getElementById('generateBtn').addEventListener('click', generateCR);

  if (document.getElementById('transmettreBtn'))
    document.getElementById('transmettreBtn').addEventListener('click', ()=>{
      if(!crGenere) return alert("Générez d'abord le compte rendu !");
      if(!infosValidees) return alert("Validez vos informations !");
      
      const grade = document.getElementById('grade')?.value.trim() || '';
      const nomPrenom = document.getElementById('nomPrenom')?.value.trim() || '';
      const nigend = document.getElementById('nigend')?.value.trim() || '';
      const crt = document.getElementById('crt')?.value.trim() || '';

      let contenuQR = `GRADE: ${grade}\nNOM: ${nomPrenom}\nNIGEND: ${nigend}\nCRT: ${crt}\n\n`;
      ['train','bus','vl','pl'].forEach(t=>{
        const typeLabel = t.charAt(0).toUpperCase()+t.slice(1);
        contenuQR += `${typeLabel}: ${state.vehicules[t]} / ${state.cv[t]} CV / ${state.cf[t]} CF\n`;
      });
      const totalVehicules = ['train','bus','vl','pl'].reduce((a,t)=>a+state.vehicules[t],0);
      const totalPersonnes = ['train','bus','vl','pl'].reduce((a,t)=>a+state.cv[t]+state.cf[t],0);
      contenuQR += `\nTOTAL MOYENS : ${totalVehicules}\nTOTAL PERSONNES : ${totalPersonnes}`;

      if(document.getElementById('compteRendu'))
        document.getElementById('compteRendu').value = contenuQR;

      const qrDiv = document.getElementById('qrcode');
      if(qrDiv){
        qrDiv.innerHTML = "";
        new QRCode(qrDiv, {
          text: contenuQR,
          width: 256,
          height: 256,
          colorDark: "#000000",
          colorLight: "#ffffff",
          correctLevel: QRCode.CorrectLevel.L
        });
      }
    });

  if (document.getElementById('resetBtn'))
    document.getElementById('resetBtn').addEventListener('click', ()=>{
      if(!confirm("Voulez-vous vraiment tout effacer ?")) return;
      state.vehicules={train:0,bus:0,vl:0,pl:0};
      state.cv={train:0,bus:0,vl:0,pl:0};
      state.cf={train:0,bus:0,vl:0,pl:0};
      updateUI();
      crGenere=false;
      if(document.getElementById('compteRendu')) document.getElementById('compteRendu').value='';
      if(document.getElementById('qrcode')) document.getElementById('qrcode').innerHTML='';
      localStorage.removeItem('moyensData');
      localStorage.removeItem('siteSelection');
	   displaySelectedSite();
       filtrerCompteurs();
    });

  // Boutons Infos
  if (document.getElementById('validerInfos'))
    document.getElementById('validerInfos').addEventListener('click',()=>{
      const grade = document.getElementById('grade')?.value.trim();
      const nomPrenom = document.getElementById('nomPrenom')?.value.trim();
      const nigend = document.getElementById('nigend')?.value.trim();
      const crt = document.getElementById('crt')?.value.trim();
      if(!grade||!nomPrenom||!nigend||!crt) return alert("Remplissez tous les champs !");
      infosValidees = true;
      saveInfos();
      disableInfos(true);
      alert(`Informations validées :\nGrade: ${grade}\nNom Prénom: ${nomPrenom}\nNigend: ${nigend}\nCRT: ${crt}`);
    });

  if (document.getElementById('resetInfosBtn'))
    document.getElementById('resetInfosBtn').addEventListener('click',()=>{
      if(!confirm("Voulez-vous vraiment effacer les infos ?")) return;
      state.infos = {grade:'',nomPrenom:'',nigend:'',crt:''};
      localStorage.removeItem('infosPersonnelles');
      loadInfos();
      disableInfos(false);
      infosValidees = false;
      alert("Infos effacées");
    });

})();  

// Fonction de navigation
  function showPage(pageId) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.getElementById(pageId).classList.add('active');

  if (pageId === "vehiculesPage") {
    filtrerCompteurs(); // applique le filtre à chaque fois qu’on ouvre la page compteurs
  }

  if (pageId === "homePage") {
    displaySelectedSite(); // met à jour le bandeau sur l’accueil
  }
}

// Service Worker
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('service-worker.js')
      .then(reg => console.log("✅ Service Worker enregistré", reg))
      .catch(err => console.log("❌ Erreur Service Worker", err));
  });
}
// --------- SCRIPT FICHE ESI ----------
function setCurrentDateTime() {
    const now = new Date();
    const timeString = now.toTimeString().slice(0, 5);
    const dateString = now.toISOString().split('T')[0];
    
    document.getElementById('heure').value = timeString;
    document.getElementById('dateIntervention').value = dateString;
}

// Initialiser avec la date/heure actuelle
setCurrentDateTime();

function calculerAge() {
    const jour = parseInt(document.getElementById("jour").value);
    const mois = parseInt(document.getElementById("mois").value) - 1;
    const annee = parseInt(document.getElementById("annee").value);
    if (!jour || mois < 0 || !annee) return;
    const today = new Date();
    const naissance = new Date(annee, mois, jour);
    let age = today.getFullYear() - naissance.getFullYear();
    const m = today.getMonth() - naissance.getMonth();
    if (m < 0 || (m === 0 && today.getDate() < naissance.getDate())) age--;
    document.getElementById("age").value = age;
}

function autoNext(input, nextInputId, maxLength) {
    input.addEventListener('input', function() {
        if (this.value.length >= maxLength) {
            document.getElementById(nextInputId).focus();
        }
        calculerAge();
    });
}

autoNext(document.getElementById('jour'), 'mois', 2);
autoNext(document.getElementById('mois'), 'annee', 2);
document.getElementById('annee').addEventListener('input', calculerAge);

document.getElementById('immatriculation').addEventListener('input', function() {
    this.value = this.value.toUpperCase();
});

// Gestion du champ "Autre" pour les pièces d'identité
document.getElementById('autreCheck').addEventListener('change', function() {
    const autreTexte = document.getElementById('autreTexte');
    if (this.checked) {
        autreTexte.disabled = false;
        autreTexte.focus();
    } else {
        autreTexte.disabled = true;
        autreTexte.value = '';
        this.value = '';
    }
});

document.getElementById('autreTexte').addEventListener('input', function() {
    const autreCheck = document.getElementById('autreCheck');
    if (this.value.trim()) {
        autreCheck.value = 'Autre : ' + this.value.trim();
    } else {
        autreCheck.value = '';
    }
});

function formatDateNaissance(jour, mois, annee) {
    return `${jour.toString().padStart(2, '0')}/${mois.toString().padStart(2, '0')}/${annee}`;
}

function formatDateIntervention(dateStr) {
    if (!dateStr) return '';
    const [annee, mois, jour] = dateStr.split("-");
    return `${jour}/${mois}/${annee}`;
}

document.getElementById('ficheForm').addEventListener('submit', function(e){
    e.preventDefault();
    const pieces = Array.from(document.querySelectorAll('input[name="piece"]:checked')).map(cb => cb.value);
    
    const jourVal = document.getElementById('jour').value;
    const moisVal = document.getElementById('mois').value;
    const anneeVal = document.getElementById('annee').value;
    
    const fiche = {
        categorie: document.getElementById('categorie').value,
        nom: document.getElementById('nom').value,
        prenom: document.getElementById('prenom').value,
        sexe: document.getElementById('sexe').value,
        nationalite: document.getElementById('nationalite').value,
        jour: jourVal,
        mois: moisVal,
        annee: anneeVal,
        dateNaissance: formatDateNaissance(jourVal, moisVal, anneeVal),
        age: document.getElementById('age').value,
        heure: document.getElementById('heure').value,
        dateIntervention: document.getElementById('dateIntervention').value,
        lieuInterpellation: document.getElementById('lieuInterpellation').value,
suitesDonnees: document.getElementById('suitesDonnees').value,
 villeDepart: document.getElementById('villeDepart').value,
        paysDepart: document.getElementById('paysDepart').value,
        villeDestination: document.getElementById('villeDestination').value,
        paysDestination: document.getElementById('paysDestination').value,
        vehicule: document.getElementById('vehicule').value,
        immatriculation: document.getElementById('immatriculation').value,
        piecesIdentite: pieces
    };
    
    const fiches = JSON.parse(localStorage.getItem('fichesESI') || '[]');
    fiches.push(fiche);
    localStorage.setItem('fichesESI', JSON.stringify(fiches));
    this.reset();
    setCurrentDateTime();
    afficherHistorique();
});

function afficherHistorique() {
    const historiqueDiv = document.getElementById('historique');
    historiqueDiv.innerHTML = '';
    const fiches = JSON.parse(localStorage.getItem('fichesESI') || '[]');
    fiches.forEach((fiche, index) => {
        const ficheDiv = document.createElement('div');
        ficheDiv.className = 'fiche';
        ficheDiv.innerHTML = `
            <strong>Fiche #${index+1} ${fiche.categorie}</strong><br>
            Nom: ${fiche.nom} ${fiche.prenom} | Sexe: ${fiche.sexe} | Nationalité: ${fiche.nationalite}<br>
            Date de naissance: ${fiche.dateNaissance || 'Non renseignée'} | Âge: ${fiche.age} ans<br>
           Intervention: ${fiche.heure || fiche.heureDate} le ${formatDateIntervention(fiche.dateIntervention)} 
Lieu: ${fiche.lieuInterpellation} | Suites données: ${fiche.suitesDonnees || ''}<br>
           Départ: ${fiche.villeDepart}, ${fiche.paysDepart} | Destination: ${fiche.villeDestination}, ${fiche.paysDestination}<br>
            Véhicule: ${fiche.vehicule} | Immatriculation: ${fiche.immatriculation}<br>
            Pièces d'identité: ${fiche.piecesIdentite.join(", ")}<br>
            <button onclick="modifierFiche(${index})" class="green">Modifier</button>
            <button onclick="supprimerFiche(${index})" class="red">Supprimer</button>
        `;
        historiqueDiv.appendChild(ficheDiv);
    });
}

function supprimerFiche(index) {
    if (confirm("Voulez-vous vraiment supprimer cette fiche ?")) {
        const fiches = JSON.parse(localStorage.getItem('fichesESI') || '[]');
        fiches.splice(index, 1);
        localStorage.setItem('fichesESI', JSON.stringify(fiches));
        afficherHistorique();
    }
}

function modifierFiche(index) {
    const fiches = JSON.parse(localStorage.getItem('fichesESI') || '[]');
    const fiche = fiches[index];
document.getElementById('categorie').value = fiche.categorie;
    document.getElementById('nom').value = fiche.nom;
    document.getElementById('prenom').value = fiche.prenom;
    document.getElementById('sexe').value = fiche.sexe;
    document.getElementById('nationalite').value = fiche.nationalite;
    document.getElementById('jour').value = fiche.jour;
    document.getElementById('mois').value = fiche.mois;
    document.getElementById('annee').value = fiche.annee;
    document.getElementById('age').value = fiche.age;
    document.getElementById('villeDepart').value = fiche.villeDepart;
    document.getElementById('paysDepart').value = fiche.paysDepart;
    document.getElementById('villeDestination').value = fiche.villeDestination;
    document.getElementById('paysDestination').value = fiche.paysDestination;
    document.getElementById('heure').value = fiche.heure || '';
    document.getElementById('dateIntervention').value = fiche.dateIntervention || '';
    document.getElementById('lieuInterpellation').value = fiche.lieuInterpellation;
document.getElementById('suitesDonnees').value = fiche.suitesDonnees || '';
    document.getElementById('vehicule').value = fiche.vehicule;
    document.getElementById('immatriculation').value = fiche.immatriculation;
    
    // Réinitialiser toutes les cases à cocher
    document.querySelectorAll('input[name="piece"]').forEach(cb => cb.checked = false);
    document.getElementById('autreTexte').value = '';
    document.getElementById('autreTexte').disabled = true;
    
    // Cocher les pièces d'identité correspondantes
    fiche.piecesIdentite.forEach(val => {
        if (val.startsWith('Autre : ')) {
            document.getElementById('autreCheck').checked = true;
            document.getElementById('autreTexte').disabled = false;
            document.getElementById('autreTexte').value = val.replace('Autre : ', '');
            document.getElementById('autreCheck').value = val;
        } else {
            const cb = Array.from(document.querySelectorAll('input[name="piece"]')).find(c => c.value === val);
            if (cb) cb.checked = true;
        }
    });
    
    fiches.splice(index, 1);
    localStorage.setItem('fichesESI', JSON.stringify(fiches));
    afficherHistorique();
}

document.getElementById('effacerFiches').addEventListener('click', function() {
    if (confirm("Voulez-vous vraiment effacer toutes les fiches ?")) {
        localStorage.removeItem('fichesESI');
        afficherHistorique();
        alert("Toutes les fiches ont été effacées !");
    }
});

afficherHistorique();
/* ---------- BLOC JS COMPLET POUR ESI+VISA (195 pays) ---------- */
(function(){
  // 1) Liste d'environ 195 pays
  const allCountries = [
    "Afghanistan","Albanie","Algérie","Allemagne","Andorre","Angola","Antigua-et-Barbuda","Argentine","Arménie","Australie",
    "Autriche","Azerbaïdjan","Bahamas","Bahreïn","Bangladesh","Barbade","Biélorussie","Belgique","Belize","Bénin",
    "Bhoutan","Bolivie","Bosnie-Herzégovine","Botswana","Brésil","Brunei","Bulgarie","Burkina Faso","Burundi","Cabo Verde",
    "Cambodge","Cameroun","Canada","République centrafricaine","Tchad","Chili","Chine","Colombie","Comores","Congo",
    "République démocratique du Congo","Costa Rica","Côte d'Ivoire","Croatie","Cuba","Chypre","République tchèque","Danemark","Djibouti","Dominique",
    "République dominicaine","Équateur","Égypte","El Salvador","Guinée équatoriale","Érythrée","Estonie","Eswatini","Éthiopie","Fidji",
    "Finlande","France","Gabon","Gambie","Géorgie","Ghana","Grèce","Grenade","Guatemala",
    "Guinée","Guinée-Bissau","Guyana","Haïti","Honduras","Hongrie","Islande","Inde","Indonésie","Iran",
    "Irak","Irlande","Israël","Italie","Jamaïque","Japon","Jordanie","Kazakhstan","Kenya","Kiribati",
    "Koweït","Kirghizistan","Laos","Lettonie","Liban","Lesotho","Liberia","Libye","Liechtenstein","Lituanie",
    "Luxembourg","Macédoine du Nord","Madagascar","Malawi","Malaisie","Maldives","Mali","Malte","Îles Marshall","Mauritanie",
    "Maurice","Mexique","Micronésie","Moldavie","Monaco","Mongolie","Monténégro","Maroc","Mozambique","Myanmar",
    "Namibie","Nauru","Népal","Pays-Bas","Nouvelle-Zélande","Nicaragua","Niger","Nigéria","Corée du Nord","Norvège",
    "Oman","Pakistan","Palaos","Panama","Papouasie-Nouvelle-Guinée","Paraguay","Pérou","Philippines","Pologne","Portugal",
    "Qatar","Roumanie","Russie","Rwanda","Saint-Kitts-et-Nevis","Sainte-Lucie","Saint-Vincent-et-les-Grenadines","Samoa","Saint-Marin","Sao Tomé-et-Principe",
    "Arabie Saoudite","Sénégal","Serbie","Seychelles","Sierra Leone","Singapour","Slovaquie","Slovénie","Îles Salomon","Somalie",
    "Afrique du Sud","Corée du Sud","Soudan du Sud","Espagne","Sri Lanka","Soudan","Suriname","Suède","Suisse","Syrie",
    "Taïwan","Tadjikistan","Tanzanie","Thaïlande","Timor-Leste","Togo","Tonga","Trinité-et-Tobago","Tunisie","Turquie",
    "Turkménistan","Tuvalu","Ouganda","Ukraine","Émirats arabes unis","Royaume-Uni","États-Unis","Uruguay","Ouzbékistan","Vanuatu",
    "Vatican","Venezuela","Vietnam","Yémen","Zambie","Zimbabwe","Kosovo"
  ];

  // 2) Pays sans visa court ni long
  const neverNeed = [
    "Autriche","Belgique","Bulgarie","Chypre","République tchèque","Croatie","Danemark","Estonie","Finlande","France",
    "Allemagne","Grèce","Hongrie","Irlande","Italie","Lettonie","Lituanie","Luxembourg","Malte","Pays-Bas",
    "Pologne","Portugal","Roumanie","Slovaquie","Slovénie","Espagne","Suède",
    "Islande","Liechtenstein","Norvège","Suisse","Monaco","Andorre","Saint-Marin","Vatican"
  ];

  // 3) Pays exemptés de visa court séjour
  const shortExempt = [
    "Albanie","Bosnie-Herzégovine","Monténégro","Macédoine du Nord","Serbie","Moldavie","Ukraine","Géorgie",
    "Argentine","Bahamas","Barbade","Bolivie","Brésil","Canada","Chili","Colombie","Costa Rica",
    "Dominique","Équateur","El Salvador","Grenade","Guatemala","Guyana","Honduras","Jamaïque","Mexique",
    "Nicaragua","Panama","Paraguay","Pérou","Suriname","Trinité-et-Tobago","Uruguay","Venezuela",
    "Australie","Brunei","Japon","Malaisie","Nouvelle-Zélande","Singapour","Corée du Sud","Israël","Taïwan",
    "Émirats arabes unis","Kiribati","Îles Marshall","Micronésie","Nauru","Palaos","Samoa","Îles Salomon","Tonga","Tuvalu","Vanuatu",
    "Maurice","Seychelles","États-Unis"
  ];

  // 4) Construction de visaData
  const visaData = { court: {}, long: {} };
  allCountries.forEach(country => {
    if (neverNeed.includes(country)) {
      visaData.court[country] = false;
      visaData.long[country] = false;
    } else if (shortExempt.includes(country)) {
      visaData.court[country] = false;
      visaData.long[country] = true;
    } else {
      visaData.court[country] = true;
      visaData.long[country] = true;
    }
  });

  // 5) Pays avec exemption biométrique
  const biometricExemptions = ["Albanie","Bosnie-Herzégovine","Macédoine du Nord","Monténégro","Serbie","Moldavie","Ukraine","Géorgie"];

  // 6) Système d'autocomplétion
  let selectedCountry = '';
  let currentSelection = -1;
  const paysInput = document.getElementById('paysInput');
  const paysDropdown = document.getElementById('paysDropdown');
  
  const sortedCountries = allCountries.slice().sort((a,b) => a.localeCompare(b, 'fr', {ignorePunctuation: true}));

  function normalizeText(text) {
    return text
      .toLowerCase()
      .normalize('NFD')
      .replace(/[\u0300-\u036f]/g, '') // Supprime les accents
      .replace(/[-\s]/g, ''); // Supprime tirets et espaces
  }

  function filterCountries(searchTerm) {
    const normalizedSearch = normalizeText(searchTerm);
    return sortedCountries.filter(country => 
      normalizeText(country).includes(normalizedSearch)
    ).slice(0, 10);
  }

  function showDropdown(countries) {
    paysDropdown.innerHTML = '';
    if (countries.length === 0) {
      paysDropdown.style.display = 'none';
      return;
    }
    
    countries.forEach((country, index) => {
      const option = document.createElement('div');
      option.className = 'pays-option';
      option.textContent = country;
      option.addEventListener('click', () => selectCountry(country));
      paysDropdown.appendChild(option);
    });
    
    paysDropdown.style.display = 'block';
    currentSelection = -1;
  }

  function selectCountry(country) {
    selectedCountry = country;
    paysInput.value = country;
    paysDropdown.style.display = 'none';
    checkVisa(); // Vérification automatique
  }

  function hideDropdown() {
    setTimeout(() => {
      paysDropdown.style.display = 'none';
    }, 200);
  }

  function updateSelection(direction) {
    const options = paysDropdown.querySelectorAll('.pays-option');
    if (options.length === 0) return;
    
    if (currentSelection >= 0) {
      options[currentSelection].classList.remove('selected');
    }
    
    currentSelection += direction;
    if (currentSelection < 0) currentSelection = options.length - 1;
    if (currentSelection >= options.length) currentSelection = 0;
    
    options[currentSelection].classList.add('selected');
    options[currentSelection].scrollIntoView({ block: 'nearest' });
  }

  // Fonction de vérification automatique
  function checkVisa() {
    const pays = selectedCountry || paysInput.value.trim();
    const duree = document.getElementById('duree').value;
    const resultat = document.getElementById('resultat');
    
    if (!pays || !allCountries.includes(pays)) {
      resultat.innerHTML = '';
      return;
    }
    
    const needsVisa = visaData[duree][pays];
    let html = '';
    
    if (needsVisa) {
      html = `<span style="color: #cc0000;">Visa requis</span> pour ce séjour (${duree === 'court' ? 'court (<90j)' : 'long (>90j)'}). ` +
             `Voir la procédure sur <a href="https://france-visas.gouv.fr/web/france-visas/assistant-visa" target="_blank" rel="noopener">France-Visas</a>.`;
    } else {
      html = `<span style="color: #008000;">Pas de visa requis</span> pour ce séjour (${duree === 'court' ? 'court (<90j)' : 'long (>90j)'}). ` +
             `Vérifier conditions particulières sur <a href="https://france-visas.gouv.fr/web/france-visas/assistant-visa" target="_blank" rel="noopener">France-Visas</a>.`;
    }

    if (!needsVisa && duree === 'court' && biometricExemptions.includes(pays)) {
      html += ` <br><small>Note : l'exemption peut demander un passeport biométrique.</small>`;
    }
    
    resultat.innerHTML = html;
  }

  // Event listeners
  paysInput.addEventListener('input', (e) => {
    const searchTerm = e.target.value.trim();
    selectedCountry = '';
    
    if (searchTerm.length === 0) {
      paysDropdown.style.display = 'none';
      document.getElementById('resultat').innerHTML = '';
      return;
    }
    
    const filtered = filterCountries(searchTerm);
    showDropdown(filtered);
  });

  paysInput.addEventListener('keydown', (e) => {
    const dropdown = paysDropdown;
    const options = dropdown.querySelectorAll('.pays-option');
    
    if (dropdown.style.display === 'none' || options.length === 0) return;
    
    switch(e.key) {
      case 'ArrowDown':
        e.preventDefault();
        updateSelection(1);
        break;
      case 'ArrowUp':
        e.preventDefault();
        updateSelection(-1);
        break;
      case 'Enter':
        e.preventDefault();
        if (currentSelection >= 0) {
          selectCountry(options[currentSelection].textContent);
        }
        break;
      case 'Escape':
        paysDropdown.style.display = 'none';
        break;
    }
  });

  paysInput.addEventListener('blur', hideDropdown);
  paysInput.addEventListener('focus', (e) => {
    if (e.target.value.trim()) {
      const filtered = filterCountries(e.target.value);
      showDropdown(filtered);
    }
  });

  // Event listener pour le changement de durée
  document.getElementById('duree').addEventListener('change', checkVisa);

  // Fonction globale pour rétrocompatibilité (au cas où)
  window.verifierVisa = checkVisa;

  window._esiVisaData = { allCountries, neverNeed, shortExempt, visaData, biometricExemptions };
  console.debug("ESI+Visa: visaData initialisé pour", allCountries.length, "pays. Voir window._esiVisaData.");
  
})();
  // Filtrage site
  function filtrerCompteurs() {
  const site = localStorage.getItem("siteSelection");

  const trainCard = document.getElementById("trainCard");
  const busCard   = document.getElementById("busCard");
  const vlCard    = document.getElementById("vlCard");
  const plCard    = document.getElementById("plCard");

  // cacher tout
  if (trainCard) trainCard.style.display = "none";
  if (busCard)   busCard.style.display = "none";
  if (vlCard)    vlCard.style.display = "none";
  if (plCard)    plCard.style.display = "none";

 // 🔥 si aucun site choisi → afficher tout
  if (!site) {
    if (trainCard) trainCard.style.display = "block";
    if (busCard)   busCard.style.display = "block";
    if (vlCard)    vlCard.style.display = "block";
    if (plCard)    plCard.style.display = "block";
    return;
  }
  
  // afficher selon site choisi
  if (site === "Breil") {
    if (trainCard) trainCard.style.display = "block";
    if (busCard)   busCard.style.display = "block";
  } else if (site === "La Turbie") {
    if (vlCard)    vlCard.style.display = "block";
    if (plCard)    plCard.style.display = "block";
    if (busCard)   busCard.style.display = "block";
  } else { // DSI Tende ou autre
    if (trainCard) trainCard.style.display = "block";
    if (busCard)   busCard.style.display = "block";
    if (vlCard)    vlCard.style.display = "block";
    if (plCard)    plCard.style.display = "block";
  }
}

// appeler au chargement
filtrerCompteurs();
// ---- Gestion Site choisi ----
function selectSite(site) {
  localStorage.setItem("siteSelection", site);
  displaySelectedSite();
   filtrerCompteurs(); // applique le filtre immédiatement
}

function displaySelectedSite() {
  const site = localStorage.getItem("siteSelection");
  const display = document.getElementById("selectedSiteDisplay");
  if (display) {
    display.textContent = site ? "📍 Site choisi : " + site : "📍 Aucun site choisi";
  }
}

// Afficher au chargement
document.addEventListener("DOMContentLoaded", displaySelectedSite);

</script>

</body>
</html>

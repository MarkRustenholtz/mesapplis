<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>CR Gendarmerie</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#2c3e50">
<link rel="apple-touch-icon" href="icon-192.png">

<!-- Font Awesome pour les icônes -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
  body {
    font-family: Arial, sans-serif;
    margin: 10px;
    max-width: 900px;
    margin-left: auto;
    margin-right: auto;
    background: #fff;
    color: #222;
  }

  /* Titre bleu gendarmerie */
  h1 {
    color: white;
    background-color: #003366; /* Bleu gendarmerie */
    padding: 12px;
    border-radius: 8px;
    text-align: center;
  }
  h1 {
  color: white;
  background-color: #003366; /* bleu gendarmerie */
  padding: 12px;
  border-radius: 8px;
  text-align: center;
  margin-bottom: 20px;
} 
  h1 .sous-titre {
  font-size: 0.6em; /* plus petit */
  font-weight: normal;
  display: block;
  margin-top: 4px;
}


  h2,h3 {
    text-align:center;
  }

  label {
    display: block;
    margin: 6px 0 3px 0;
  }
  input[type=text], input[type=date], input[type=time], select {
    width: 100%;
    padding: 6px 8px;
    box-sizing: border-box;
    border-radius: 4px;
    border: 1px solid #aaa;
    font-size: 1em;
  }
  button {
    cursor: pointer;
    font-weight: bold;
    border: none;
    border-radius: 6px;
    padding: 6px 12px;
    font-size: 1.1em;
    margin: 4px 2px;
    min-width: 36px;
    min-height: 36px;
    user-select:none;
    transition: background-color 0.2s ease;
    display: inline-flex;
    align-items: center;
    gap: 6px; /* espace icône/texte */
  }
  button.plusminus {
    width: 48px;
    border-radius: 10px;
    font-size: 1.5em;
  }
  button.plusminus:hover { background-color: #ddd; }
  button.red {
    background-color: #d9534f; color: white; font-weight: bold;
  }
  button.red:hover { background-color: #c9302c; }
  button.blue {
    background-color: #3498db; color: white; font-weight: bold;
  }
  button.blue:hover { background-color: #217dbb; }
  .flex-row {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    align-items: center;
  }
  .flex-col {
    flex: 1 1 200px;
    min-width: 200px;
  }
  .vehicle-card {
    border: 2px solid #3498db;
    border-radius: 10px;
    padding: 12px;
    margin-bottom: 18px;
    background: #f9fafe;
  }
  .vehicle-card h3 {
    margin-top: 0;
    color: #2c3e50;
  }
  .number-input {
    width: 60px;
    font-size: 1.1em;
    text-align: center;
    border-radius: 4px;
    border: 1px solid #aaa;
    padding: 4px 6px;
  }
  .manual-input {
    width: 80px;
    font-size: 1em;
    padding: 4px 6px;
  }
  textarea {
    width: 100%;
    min-height: 200px;
    font-family: monospace;
    font-size: 1em;
    padding: 8px;
    box-sizing: border-box;
    border-radius: 4px;
    border: 1px solid #ccc;
    resize: vertical;
  }
  .small-note {
    font-size: 0.85em;
    color: #666;
    margin-top: -6px;
    margin-bottom: 12px;
  }

  /* --- Important: sections hidden by default (single-page behavior) --- */
  section { display: none; }
  hr { display: none; }

  /* Responsive adjustments */
  @media (max-width: 768px) {
    .header-inputs { display: flex; flex-wrap: wrap; gap: 6px; }
    .header-inputs label { flex: 1 1 30%; font-size: 0.9em; }
    .header-inputs input { width: 100%; padding: 4px; font-size: 1em; }
  }

  /* Navigation */
  nav { text-align:center; margin: 12px 0; }
  nav button { margin: 6px 4px; padding: 8px 12px; }

  .menu {
  display: inline-block;       /* s’adapte à la largeur des boutons */
  border: 2px solid #003366;   /* cadre bleu gendarmerie */
  border-radius: 10px;          /* coins arrondis */
  padding: 8px;                 /* espace intérieur */
  background-color: #f9f9f9;    /* optionnel, pour faire ressortir le cadre */
}
nav button.active {
  border: 2px solid #003366; /* cadre bleu gendarmerie */
  background-color: #cce0ff;  /* surbrillance légère */
}


  /* Couleurs boutons */
  .btn-infos { background-color: #3498db; color:white; }
  .btn-esr { background-color: #2ecc71; color:white; }
  .btn-materiel { background-color: #f39c12; color:white; }
  .btn-compteurs { background-color: #9b59b6; color:white; }
  .btn-esi { background-color: #e74c3c; color:white; }
  .btn-passeur { background-color: #16a085; color:white; }
  .btn-obs { background-color: #E5E7EB; color:black; }
  .btn-deroulement { background-color: #d35400; color:white; }
  .btn-cr { background-color: #27ae60; color:white; }
</style>

<script src="https://unpkg.com/html5-qrcode"></script>
</head>
<body>
<h1>
  CR GENDARMERIE<br>
  <span class="sous-titre">LIMES Breil La Turbie DSI Tende</span>
</h1>


<!-- Menu -->
<nav class="menu">
  <button class="btn-infos" onclick="showPage('infosSection')">
    <i class="fas fa-calendar-alt"></i> Infos
  </button>
  <button class="btn-esr" onclick="showPage('esrSection')">
    <i class="fas fa-user-shield"></i> ESR
  </button>
  <button class="btn-materiel" onclick="showPage('materielSection')">
    <i class="fas fa-video"></i> Matériel
  </button>
  <button class="btn-compteurs" onclick="showPage('vehiculesSection')">
    <i class="fas fa-chart-bar"></i> Compteurs
  </button>
  <button class="btn-esi" onclick="showPage('esiSection')">
    <i class="fas fa-passport"></i> ESI
  </button>
  <button class="btn-passeur" onclick="showPage('passeurSection')">
    <i class="fas fa-user-secret"></i> Passeurs
  </button>
  <button class="btn-obs" onclick="showPage('observationsSection')">
    <i class="fas fa-eye"></i> Observations
  </button>
  <button class="btn-deroulement" onclick="showPage('deroulementSection')">
    <i class="fas fa-tasks"></i> Déroulement
  </button>
  <button class="btn-pulsar" onclick="showPage('pulsarSection')">
    <i class="fas fa-fire"></i> Pulsar
  </button>
  <button class="btn-cr" onclick="showPage('generateSection')">
    <i class="fas fa-file-alt"></i> Compte Rendu
  </button>
  <button onclick="window.open('https://markrustenholtz.github.io/esi/', '_blank')">
    ESI + Visa
  </button>
</nav>

<!-- JS pour navigation -->
<script>
  function showPage(pageId) {
  // cacher toutes les sections
  document.querySelectorAll('section').forEach(sec => sec.style.display = 'none');

  // afficher la section demandée
  const el = document.getElementById(pageId);
  if(el) el.style.display = 'block';

  // --- gérer l'état actif des boutons ---
  document.querySelectorAll('nav button').forEach(btn => btn.classList.remove('active'));
  const btn = document.querySelector(`nav button[onclick="showPage('${pageId}')"]`);
  if(btn) btn.classList.add('active');

  // scroll top
  window.scrollTo(0,0);
}
  document.addEventListener('DOMContentLoaded', () => {
    showPage('infosSection');
  });
</script>

<!-- === SECTIONS === -->

<section id="infosSection">
  <label for="siteSelect">Site :</label>
  <select id="siteSelect" aria-label="Sélection du site">
    <option value="Breil">Breil</option>
    <option value="La Turbie">La Turbie</option>
    <option value="DSI Tende">DSI Tende</option>
  </select>

  <div class="flex-row" style="gap:15px; margin-top:10px;">
    <div class="flex-col">
      <label for="dateInput">Date :</label>
      <input type="date" id="dateInput" />
    </div>
    <div class="flex-col">
      <label for="heureDebutInput">Heure début :</label>
      <input type="time" id="heureDebutInput" />
    </div>
    <div class="flex-col">
      <label for="heureFinInput">Heure fin :</label>
      <input type="time" id="heureFinInput" />
    </div>
  </div>
</section>

<section id="esrSection">
  <h2>ESR (Effectif)</h2>
  <div id="esrList"></div>
  <div style="margin-top:6px;">
    <input type="text" id="esrGrade" placeholder="Grade" />
    <input type="text" id="esrNom" placeholder="Nom Prénom" />
    <input type="text" id="esrNigend" placeholder="Nigend" />
    <input type="text" id="esrCRT" placeholder="CRT ( ex: 06/1 Nice )" />
    <button id="addEsrBtn" class="blue">Ajouter ESR</button>
     <button id="delEsrBtn" class="red">Supprimer dernier ESR</button>
  </div>
  <div class="small-note">Tous les champs doivent être remplis pour ajouter un ESR</div>
</section>

<section id="materielSection">
  <h2>Matériel et utilisateurs</h2>
  <div class="flex-row" style="gap:12px;">
    <div style="flex:2;">
      <label>Caméra n° :
        <input type="text" id="cameraNum" placeholder="Numéro  caméra" />
      </label>
    </div>
    <div style="flex:3;">
      <label>Porteur caméra (ESR) :
        <select id="cameraESR"></select>
      </label>
    </div>
  </div>
  <div class="flex-row" style="gap:12px;">
    <div style="flex:2;">
      <label>Tablette n° 1 :
        <input type="text" id="tablette1Num" placeholder="N°(ex: 6)" />
      </label>
    </div>
    <div style="flex:3;">
      <label>Utilisateur tablette 1 (ESR) :
        <select id="tablette1ESR"></select>
      </label>
    </div>
  </div>
  <div class="flex-row" style="gap:12px;">
    <div style="flex:2;">
      <label>Tablette n° 2 (optionnel) :
        <input type="text" id="tablette2Num" placeholder="N°(ex: 7)" />
      </label>
    </div>
    <div style="flex:3;">
      <label>Utilisateur tablette 2 (ESR) :
        <select id="tablette2ESR"></select>
      </label>
    </div>
  </div>
  <div style="margin-top:12px;">
    <label>Véhicule de service (immatriculation) :
      <input type="text" id="vehiculeService" placeholder="Ex: AB-123-CD" />
    </label>
  </div>
</section>

<section id="vehiculesSection">
  <h2>Moyens / Personnes contrôlées</h2>

  <div class="vehicle-card" id="trainCard">
    <h3>Train</h3>
    <div class="flex-row" style="align-items:center;">
      <div>
        <button class="plusminus" data-type="train" data-field="vehicles" data-action="minus">-</button>
        <span id="trainVehiclesCount">0</span> véhicules
        <button class="plusminus" data-type="train" data-field="vehicles" data-action="plus">+</button>
      </div>
      <div style="margin-left:20px;">
        <button class="plusminus" data-type="train" data-field="cv" data-action="minus">-</button>
        <span id="trainCvCount">0</span> CV
        <button class="plusminus" data-type="train" data-field="cv" data-action="plus">+</button>
      </div>
      <div>
        <label style="margin-left:15px;">Ajouter CV manuellement:
          <input type="number" id="trainCvManual" class="manual-input" min="0" value="0" />
          <button id="trainCvAddManualBtn">Ajouter</button>
        </label>
      </div>
      <div style="margin-left:20px;">
        <button class="plusminus" data-type="train" data-field="cf" data-action="minus">-</button>
        <span id="trainCfCount">0</span> CF
        <button class="plusminus" data-type="train" data-field="cf" data-action="plus">+</button>
      </div>
      <div>
        <label style="margin-left:15px;">Ajouter CF manuellement:
          <input type="number" id="trainCfManual" class="manual-input" min="0" value="0" />
          <button id="trainCfAddManualBtn">Ajouter</button>
        </label>
      </div>
    </div>
  </div>

  <div class="vehicle-card" id="busCard">
    <h3>Bus</h3>
    <div class="flex-row" style="align-items:center;">
      <div>
        <button class="plusminus" data-type="bus" data-field="vehicles" data-action="minus">-</button>
        <span id="busVehiclesCount">0</span> véhicules
        <button class="plusminus" data-type="bus" data-field="vehicles" data-action="plus">+</button>
      </div>
      <div style="margin-left:20px;">
        <button class="plusminus" data-type="bus" data-field="cv" data-action="minus">-</button>
        <span id="busCvCount">0</span> CV
        <button class="plusminus" data-type="bus" data-field="cv" data-action="plus">+</button>
      </div>
      <div>
        <label style="margin-left:15px;">Ajouter CV manuellement:
          <input type="number" id="busCvManual" class="manual-input" min="0" value="0" />
          <button id="busCvAddManualBtn">Ajouter</button>
        </label>
      </div>
      <div style="margin-left:20px;">
        <button class="plusminus" data-type="bus" data-field="cf" data-action="minus">-</button>
        <span id="busCfCount">0</span> CF
        <button class="plusminus" data-type="bus" data-field="cf" data-action="plus">+</button>
      </div>
      <div>
        <label style="margin-left:15px;">Ajouter CF manuellement:
          <input type="number" id="busCfManual" class="manual-input" min="0" value="0" />
          <button id="busCfAddManualBtn">Ajouter</button>
        </label>
      </div>
    </div>
  </div>

  <div class="vehicle-card" id="vlCard">
    <h3>VL</h3>
    <div class="flex-row" style="align-items:center;">
      <div>
        <button class="plusminus" data-type="vl" data-field="vehicles" data-action="minus">-</button>
        <span id="vlVehiclesCount">0</span> véhicules
        <button class="plusminus" data-type="vl" data-field="vehicles" data-action="plus">+</button>
      </div>
      <div style="margin-left:20px;">
        <button class="plusminus" data-type="vl" data-field="cv" data-action="minus">-</button>
        <span id="vlCvCount">0</span> CV
        <button class="plusminus" data-type="vl" data-field="cv" data-action="plus">+</button>
      </div>
      <div>
        <label style="margin-left:15px;">Ajouter CV manuellement:
          <input type="number" id="vlCvManual" class="manual-input" min="0" value="0" />
          <button id="vlCvAddManualBtn">Ajouter</button>
        </label>
      </div>
      <div style="margin-left:20px;">
        <button class="plusminus" data-type="vl" data-field="cf" data-action="minus">-</button>
        <span id="vlCfCount">0</span> CF
        <button class="plusminus" data-type="vl" data-field="cf" data-action="plus">+</button>
      </div>
      <div>
        <label style="margin-left:15px;">Ajouter CF manuellement:
          <input type="number" id="vlCfManual" class="manual-input" min="0" value="0" />
          <button id="vlCfAddManualBtn">Ajouter</button>
        </label>
      </div>
    </div>
  </div>

  <div class="vehicle-card" id="plCard">
    <h3>PL</h3>
    <div class="flex-row" style="align-items:center;">
      <div>
        <button class="plusminus" data-type="pl" data-field="vehicles" data-action="minus">-</button>
        <span id="plVehiclesCount">0</span> véhicules
        <button class="plusminus" data-type="pl" data-field="vehicles" data-action="plus">+</button>
      </div>
      <div style="margin-left:20px;">
        <button class="plusminus" data-type="pl" data-field="cv" data-action="minus">-</button>
        <span id="plCvCount">0</span> CV
        <button class="plusminus" data-type="pl" data-field="cv" data-action="plus">+</button>
      </div>
      <div>
        <label style="margin-left:15px;">Ajouter CV manuellement:
          <input type="number" id="plCvManual" class="manual-input" min="0" value="0" />
          <button id="plCvAddManualBtn">Ajouter</button>
        </label>
      </div>
      <div style="margin-left:20px;">
        <button class="plusminus" data-type="pl" data-field="cf" data-action="minus">-</button>
        <span id="plCfCount">0</span> CF
        <button class="plusminus" data-type="pl" data-field="cf" data-action="plus">+</button>
      </div>
      <div>
        <label style="margin-left:15px;">Ajouter CF manuellement:
          <input type="number" id="plCfManual" class="manual-input" min="0" value="0" />
          <button id="plCfAddManualBtn">Ajouter</button>
        </label>
      </div>
    </div>
  </div>
</section>

<section id="esiSection">
  <h2>ESI Intercepté(s)</h2>
  <div id="esiList"></div>
  <div style="margin-top:6px;">
    <select id="esiAge" aria-label="Majeur ou mineur">
      <option value="">Majeur(e)/Mineur(e)</option>
      <option value="Majeur">Majeur</option>
      <option value="Mineur">Mineur</option>
      <option value="Majeure">Majeure</option>
      <option value="Mineure">Mineure</option>
    </select>
    <select id="esiSexe" aria-label="Sexe H/F">
      <option value="">Homme/Femme</option>
      <option value="Homme">Homme</option>
      <option value="Femme">Femme</option>
    </select>
    <input type="number" id="esiAgeNum" placeholder="Âge (chiffre)" min="0" style="width: 100px;" />
    <input type="text" id="esiNationalite" placeholder="Nationalité" />
    <input type="text" id="esiLieu" placeholder="Lieu interpellation" />
    <label for="esiHeure">Heure interpellation :</label>
    <input type="time" id="esiHeure" />
    <input type="text" id="esiSuites" placeholder="Suites données" />
    <button id="addEsiBtn" class="blue">Ajouter ESI</button>
    <button id="delEsiBtn" class="red">Supprimer dernier ESI</button>
  </div>
  <div class="small-note">Tous les champs doivent être remplis pour ajouter un ESI</div>
</section>

<section id="passeurSection">
  <h2>Passeur(s) Intercepté(s)</h2>
  <div id="passeurList"></div>
  <div style="margin-top:6px;">
    <select id="passeurAge" aria-label="Majeur ou mineur">
      <option value="">Majeur(e)/Mineur(e)</option>
      <option value="Majeur">Majeur</option>
      <option value="Mineur">Mineur</option>
      <option value="Majeure">Majeure</option>
      <option value="Mineure">Mineure</option>
    </select>
    <select id="passeurSexe" aria-label="Sexe H/F">
      <option value="">Homme/Femme</option>
      <option value="Homme">Homme</option>
      <option value="Femme">Femme</option>
    </select>
    <input type="number" id="passeurAgeNum" placeholder="Âge (chiffre)" min="0" style="width: 100px;" />
    <input type="text" id="passeurNationalite" placeholder="Nationalité" />
    <input type="text" id="passeurLieu" placeholder="Lieu interpellation" />
    <label for="passeurHeure">Heure interpellation :</label>
    <input type="time" id="passeurHeure" />
    <input type="text" id="passeurSuites" placeholder="Suites données" />
    <button id="addPasseurBtn" class="blue">Ajouter Passeur</button>
    <button id="delPasseurBtn" class="red">Suppr. dernier Passeur</button>
  </div>
  <div class="small-note">Tous les champs doivent être remplis pour ajouter un passeur</div>
</section>

<!-- Observations separate -->
<section id="observationsSection">
  <h2>Observations</h2>
  <textarea id="observations" placeholder="Difficultés éventuelles (tablette, téléphone, véhicule, ...)&#10;Autres…"></textarea>
</section>

<!-- Déroulement separate -->
<section id="deroulementSection">
  <h2>Déroulement de la mission</h2>
  <textarea id="deroulement" placeholder="Déroulement détaillé..."></textarea>
</section>

<!-- Pulsar -->
<section id="pulsarSection">
  <h2>PULSAR</h2>
  <label>
    <input type="radio" name="pulsar" id="pulsarOui" onclick="onPulsarChange()"> Oui
  </label>
  <label>
    <input type="radio" name="pulsar" id="pulsarNon" onclick="onPulsarChange()"> Non
  </label>
</section>



<!-- Generate CR Section (buttons + CR output) -->
<section id="generateSection">
  <div style="text-align:center; margin-bottom: 12px;">
    <button id="generateBtn" class="blue" style="padding:10px 20px; font-size:1.05em;">Générer compte rendu</button>
    <button id="copyBtn" style="background-color:#27ae60; color:white; font-weight:bold; padding:10px 20px; font-size:1.05em;">Copier dans le presse-papiers</button>
    <button id="scanQrBtn" style="background-color:#8e44ad; color:white; font-weight:bold; padding:10px 20px; font-size:1.05em;">Scanner QR code</button>
    <button id="resetBtn" class="red" style="font-size:1.05em;">Effacer les données sauvegardées</button>
  </div>

  <h2>Compte rendu généré :</h2>
  <textarea id="compteRendu" readonly rows="16" style="font-family:monospace; white-space:pre-wrap;"></textarea>

  <div style="margin-top:12px;">
    <h3>Résumé des ESR (scannés)</h3>
    <textarea id="resumeEsr" readonly rows="6" style="font-family:monospace; white-space:pre-wrap;"></textarea>
    <div class="small-note">Scannés: <span id="nbScans">0</span> | NIGEND: <span id="nigendList">—</span></div>
  </div>
</section>

<!-- QR Modal (unchanged) -->
<div id="qrModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.6); z-index:1000; align-items:center; justify-content:center;">
  <div style="background:#fff; padding:20px; border-radius:10px; max-width:600px; width:90%;">
    <h2>Scanner un QR code</h2>
    <div id="qr-reader" style="width:100%;"></div>
    <div id="scanLog" style="max-height:120px; overflow:auto; margin-top:10px; font-size:0.9em; background:#f0f0f0; padding:6px;"></div>
    <button onclick="closeQrModal()" style="margin-top:10px; padding:8px 16px;">Fermer</button>
  </div>
</div>

<!-- ===== main script (j'avoue j'ai laissé ton code intact, juste l'organisation HTML change) ===== -->
<script>
  (() => {
    // Données initiales
    const state = {
      site: '',
      date: '',
      heureDebut: '',
      heureFin: '',
      esrList: [],
      cameraNum: '',
      cameraESR: '',
      tablette1Num: '',
      tablette1ESR: '',
      tablette2Num: '',
      tablette2ESR: '',
      vehiculeService: '',
      vehicules: { train: 0, bus: 0, vl: 0, pl: 0 },
      cv: { train: 0, bus: 0, vl: 0, pl: 0 },
      cf: { train: 0, bus: 0, vl: 0, pl: 0 },
      esiList: [],
      passeurList: [],
      observations: '',
      deroulement: '',
      pulsar: '',
	  editingEsrIndex: null,
      editingEsiIndex: null,
      editingPasseurIndex: null,
    };
    const siteConfig = {
      "La Turbie": ["vl", "bus", "pl"],
      "Breil": ["train", "bus"]
    };

    let saveTimeout = null;
    function debounceSave() {
      if(saveTimeout) clearTimeout(saveTimeout);
      saveTimeout = setTimeout(() => {
        saveToStorage();
      }, 3000);
    }
    function saveToStorage() {
      localStorage.setItem('crGendarmerie', JSON.stringify(state));
    }
    function loadFromStorage() {
      const data = localStorage.getItem('crGendarmerie');
      if(data) {
        const parsed = JSON.parse(data);
        Object.assign(state, parsed);
      }
    }

    function updateUI() {
      document.getElementById('siteSelect').value = state.site;
      document.getElementById('dateInput').value = state.date;
      document.getElementById('heureDebutInput').value = state.heureDebut;
      document.getElementById('heureFinInput').value = state.heureFin;
      renderEsrList();
      document.getElementById('cameraNum').value = state.cameraNum;
      document.getElementById('tablette1Num').value = state.tablette1Num;
      document.getElementById('tablette2Num').value = state.tablette2Num;
      document.getElementById('vehiculeService').value = state.vehiculeService;
      populateEsrSelects();
      document.getElementById('cameraESR').value = state.cameraESR || '';
      document.getElementById('tablette1ESR').value = state.tablette1ESR || '';
      document.getElementById('tablette2ESR').value = state.tablette2ESR || '';

      ['train','bus','vl','pl'].forEach(type => {
        const vEl = document.getElementById(type+'VehiclesCount');
        const cvEl = document.getElementById(type+'CvCount');
        const cfEl = document.getElementById(type+'CfCount');
        if (vEl) vEl.textContent = state.vehicules[type] || 0;
        if (cvEl) cvEl.textContent = state.cv[type] || 0;
        if (cfEl) cfEl.textContent = state.cf[type] || 0;
      });

      // Filtrage dynamique selon le site choisi
      if (state.site && siteConfig[state.site]) {
        document.querySelectorAll(".vehicle-card").forEach(c => c.style.display = "none");
        siteConfig[state.site].forEach(type => {
          const el = document.getElementById(type + "Card");
          if(el) el.style.display = "block";
        });
      } else {
        document.querySelectorAll(".vehicle-card").forEach(c => c.style.display = "block");
      }

      renderEsiList();
      renderPasseurList();
      document.getElementById('observations').value = state.observations || '';
      document.getElementById('deroulement').value = state.deroulement || '';
    }

    // ESR functions
    function renderEsrList() {
  const container = document.getElementById('esrList');
  container.innerHTML = '';
  if(!state.esrList || state.esrList.length === 0) {
    container.textContent = 'Aucun ESR ajouté.';
    return;
  }
  const ul = document.createElement('ul');
  state.esrList.forEach((esr,i) => {
    const li = document.createElement('li');
    li.textContent = `${i+1} - ${esr.grade} ${esr.nom} - ${esr.nigend} - ${esr.crt} `;

    // bouton Modifier
    const editBtn = document.createElement('button');
    editBtn.textContent = 'Modifier';
    editBtn.className = 'blue';
    editBtn.onclick = () => {
      document.getElementById('esrGrade').value = esr.grade;
      document.getElementById('esrNom').value = esr.nom;
      document.getElementById('esrNigend').value = esr.nigend;
      document.getElementById('esrCRT').value = esr.crt;
      state.editingEsrIndex = i;
      document.getElementById('addEsrBtn').textContent = "Enregistrer";
    };

    // bouton Supprimer
    const delBtn = document.createElement('button');
    delBtn.textContent = 'Supprimer';
    delBtn.className = 'red';
    delBtn.onclick = () => {
      if(confirm(`Supprimer ${esr.grade} ${esr.nom} ?`)) {
        state.esrList.splice(i,1);
        populateEsrSelects();
        renderEsrList();
        debounceSave();
      }
    };

    li.appendChild(editBtn);
    li.appendChild(delBtn);
    ul.appendChild(li);
  });
  container.appendChild(ul);
}

  function addEsr() {
  const grade = document.getElementById('esrGrade').value.trim();
  const nom = document.getElementById('esrNom').value.trim();
  const nigend = document.getElementById('esrNigend').value.trim();
  const crt = document.getElementById('esrCRT').value.trim();
  if(!grade || !nom || !nigend || !crt) {
    alert('Merci de remplir tous les champs ESR.');
    return;
  }

  if(state.editingEsrIndex !== null && state.editingEsrIndex !== undefined) {
    // Modification
    state.esrList[state.editingEsrIndex] = {grade, nom, nigend, crt};
    state.editingEsrIndex = null;
    document.getElementById('addEsrBtn').textContent = "Ajouter ESR";
  } else {
    // Ajout
    state.esrList.push({grade, nom, nigend, crt});
  }

  document.getElementById('esrGrade').value = '';
  document.getElementById('esrNom').value = '';
  document.getElementById('esrNigend').value = '';
  document.getElementById('esrCRT').value = '';
  populateEsrSelects();
  renderEsrList();
  debounceSave();
}

    function delEsr() {
      if(state.esrList && state.esrList.length > 0) {
        state.esrList.pop();
        populateEsrSelects();
        renderEsrList();
        debounceSave();
      }
    }
    function populateEsrSelects() {
      ['cameraESR','tablette1ESR','tablette2ESR'].forEach(id => {
        const sel = document.getElementById(id);
        if(!sel) return;
        const currentVal = sel.value;
        sel.innerHTML = '<option value="">--</option>';
        (state.esrList || []).forEach((esr) => {
          const opt = document.createElement('option');
          opt.value = `${esr.grade} ${esr.nom}`;
          opt.textContent = `${esr.grade} ${esr.nom}`;
          sel.appendChild(opt);
        });
        if([...sel.options].some(o => o.value === currentVal)) sel.value = currentVal;
        else sel.value = '';
      });
    }

    // counts
    function changeCount(type, field, action) {
      if(!state.vehicules[type]) state.vehicules[type] = 0;
      if(!state.cv[type]) state.cv[type] = 0;
      if(!state.cf[type]) state.cf[type] = 0;
      if(field === 'vehicles') {
        if(action === 'plus') state.vehicules[type]++;
        else if(action === 'minus' && state.vehicules[type] > 0) state.vehicules[type]--;
      } else if(field === 'cv') {
        if(action === 'plus') state.cv[type]++;
        else if(action === 'minus' && state.cv[type] > 0) state.cv[type]--;
      } else if(field === 'cf') {
        if(action === 'plus') state.cf[type]++;
        else if(action === 'minus' && state.cf[type] > 0) state.cf[type]--;
      }
      updateUI();
      debounceSave();
    }
    function addManualCv(type) {
      const input = document.getElementById(type+'CvManual');
      const val = parseInt(input.value);
      if(isNaN(val) || val < 1) { alert('Veuillez saisir un nombre entier supérieur à 0.'); return; }
      state.cv[type] += val;
      input.value = 0;
      updateUI();
      debounceSave();
    }
    function addManualCf(type) {
      const input = document.getElementById(type+'CfManual');
      const val = parseInt(input.value);
      if(isNaN(val) || val < 1) { alert('Veuillez saisir un nombre entier supérieur à 0.'); return; }
      state.cf[type] += val;
      input.value = 0;
      updateUI();
      debounceSave();
    }

    // ESI
    function renderEsiList() {
  const container = document.getElementById('esiList');
  container.innerHTML = '';
  if(!state.esiList || state.esiList.length === 0) {
    container.textContent = 'Aucun ESI ajouté.';
    return;
  }
  const ul = document.createElement('ul');
  state.esiList.forEach((esi,i) => {
    const li = document.createElement('li');
    li.textContent = `${i+1} - ${esi.heure} - ${esi.age} - ${esi.sexe} - ${esi.ageNum} ans - ${esi.nationalite} - ${esi.lieu} - ${esi.suites} `;

    // bouton Modifier
    const editBtn = document.createElement('button');
    editBtn.textContent = 'Modifier';
    editBtn.className = 'blue';
    editBtn.onclick = () => {
      document.getElementById('esiAge').value = esi.age;
      document.getElementById('esiSexe').value = esi.sexe;
      document.getElementById('esiAgeNum').value = esi.ageNum;
      document.getElementById('esiNationalite').value = esi.nationalite;
      document.getElementById('esiLieu').value = esi.lieu;
      document.getElementById('esiHeure').value = esi.heure;
      document.getElementById('esiSuites').value = esi.suites;
      state.editingEsiIndex = i;
      document.getElementById('addEsiBtn').textContent = "Enregistrer";
    };

    // bouton Supprimer
    const delBtn = document.createElement('button');
    delBtn.textContent = 'Supprimer';
    delBtn.className = 'red';
    delBtn.onclick = () => {
      if(confirm("Supprimer cet ESI ?")) {
        state.esiList.splice(i,1);
        renderEsiList();
        debounceSave();
      }
    };

    li.appendChild(editBtn);
    li.appendChild(delBtn);
    ul.appendChild(li);
  });
  container.appendChild(ul);
}

function addEsi() {
  const heure = document.getElementById('esiHeure').value.trim();
  const age = document.getElementById('esiAge').value;
  const sexe = document.getElementById('esiSexe').value;
  const ageNum = document.getElementById('esiAgeNum').value.trim();
  const nationalite = document.getElementById('esiNationalite').value.trim();
  const lieu = document.getElementById('esiLieu').value.trim();
  const suites = document.getElementById('esiSuites').value.trim();
  if(!age || !sexe || !ageNum || !nationalite || !lieu || !suites) {
    alert('Merci de remplir tous les champs ESI.');
    return;
  }

  if(state.editingEsiIndex !== null && state.editingEsiIndex !== undefined) {
    state.esiList[state.editingEsiIndex] = {age,sexe,ageNum,nationalite,lieu,heure,suites};
    state.editingEsiIndex = null;
    document.getElementById('addEsiBtn').textContent = "Ajouter ESI";
  } else {
    state.esiList.push({age,sexe,ageNum,nationalite,lieu,heure,suites});
  }

  document.getElementById('esiAge').value = '';
  document.getElementById('esiSexe').value = '';
  document.getElementById('esiAgeNum').value = '';
  document.getElementById('esiNationalite').value = '';
  document.getElementById('esiLieu').value = '';
  document.getElementById('esiHeure').value = '';
  document.getElementById('esiSuites').value = '';
  renderEsiList();
  debounceSave();
}

    function delEsi() {
      if(state.esiList && state.esiList.length > 0) {
        state.esiList.pop();
        renderEsiList();
        debounceSave();
      }
    }

    // PASSEUR
    function renderPasseurList() {
  const container = document.getElementById('passeurList');
  container.innerHTML = '';
  if(!state.passeurList || state.passeurList.length === 0) {
    container.textContent = 'Aucun passeur ajouté.';
    return;
  }
  const ul = document.createElement('ul');
  state.passeurList.forEach((passeur,i) => {
    const li = document.createElement('li');
    li.textContent = `${i+1} - ${passeur.heure} - ${passeur.age} - ${passeur.sexe} - ${passeur.ageNum} ans - ${passeur.nationalite} - ${passeur.lieu} - ${passeur.suites} `;

    // bouton Modifier
    const editBtn = document.createElement('button');
    editBtn.textContent = 'Modifier';
    editBtn.className = 'blue';
    editBtn.onclick = () => {
      document.getElementById('passeurAge').value = passeur.age;
      document.getElementById('passeurSexe').value = passeur.sexe;
      document.getElementById('passeurAgeNum').value = passeur.ageNum;
      document.getElementById('passeurNationalite').value = passeur.nationalite;
      document.getElementById('passeurLieu').value = passeur.lieu;
      document.getElementById('passeurHeure').value = passeur.heure;
      document.getElementById('passeurSuites').value = passeur.suites;
      state.editingPasseurIndex = i;
      document.getElementById('addPasseurBtn').textContent = "Enregistrer";
    };

    // bouton Supprimer
    const delBtn = document.createElement('button');
    delBtn.textContent = 'Supprimer';
    delBtn.className = 'red';
    delBtn.onclick = () => {
      if(confirm("Supprimer ce passeur ?")) {
        state.passeurList.splice(i,1);
        renderPasseurList();
        debounceSave();
      }
    };

    li.appendChild(editBtn);
    li.appendChild(delBtn);
    ul.appendChild(li);
  });
  container.appendChild(ul);
}

function addPasseur() {
  const heure = document.getElementById('passeurHeure').value.trim();
  const age = document.getElementById('passeurAge').value;
  const sexe = document.getElementById('passeurSexe').value;
  const ageNum = document.getElementById('passeurAgeNum').value.trim();
  const nationalite = document.getElementById('passeurNationalite').value.trim();
  const lieu = document.getElementById('passeurLieu').value.trim();
  const suites = document.getElementById('passeurSuites').value.trim();
  if(!age || !sexe || !ageNum || !nationalite || !lieu || !suites) {
    alert('Merci de remplir tous les champs Passeur.');
    return;
  }

  if(state.editingPasseurIndex !== null && state.editingPasseurIndex !== undefined) {
    state.passeurList[state.editingPasseurIndex] = {age,sexe,ageNum,nationalite,lieu,heure,suites};
    state.editingPasseurIndex = null;
    document.getElementById('addPasseurBtn').textContent = "Ajouter Passeur";
  } else {
    state.passeurList.push({age,sexe,ageNum,nationalite,lieu,heure,suites});
  }

  document.getElementById('passeurAge').value = '';
  document.getElementById('passeurSexe').value = '';
  document.getElementById('passeurAgeNum').value = '';
  document.getElementById('passeurNationalite').value = '';
  document.getElementById('passeurLieu').value = '';
  document.getElementById('passeurHeure').value = '';
  document.getElementById('passeurSuites').value = '';
  renderPasseurList();
  debounceSave();
}

    function delPasseur() {
      if(state.passeurList && state.passeurList.length > 0) {
        state.passeurList.pop();
        renderPasseurList();
        debounceSave();
      }
    }

    // Compte rendu generator (utilise state)
    function generateCompteRendu() {
      if(!state.date) { alert('Merci de sélectionner une date.'); return; }
      const site = state.site;
      const date = state.date.split('-').reverse().join('/');
      const heureDebut = state.heureDebut || '';
      const heureFin = state.heureFin || '';
      const esrCount = (state.esrList || []).length;

      let cr = `LIMES ${site} - CR - ${date} - ${heureDebut} à ${heureFin}\n\n`;

      cr += `(${esrCount}) ESR\n`;
      (state.esrList || []).forEach((esr,i) => {
        cr += `${i+1} ${esr.grade} ${esr.nom} - ${esr.nigend} - CRT ${esr.crt}\n`;
      });

      cr += `\nPorteur caméra nº ${state.cameraNum} : ${state.cameraESR || ''}\n`;
      cr += `Tablette nº T${state.tablette1Num} : ${state.tablette1ESR || ''}\n`;
      if(state.tablette2Num && state.tablette2Num.trim() !== '') {
        cr += `Tablette nº T${state.tablette2Num} : ${state.tablette2ESR || ''}\n`;
      }
      if(state.vehiculeService && state.vehiculeService.trim() !== '') {
        cr += `Véhicule de service : ${state.vehiculeService}\n`;
      }

      cr += `\n1 - MOYENS / PERSONNES:\n`;

      const typesAAfficher = siteConfig[state.site] || ['train','bus','vl','pl'];
      typesAAfficher.forEach(type => {
        const vCount = state.vehicules[type] || 0;
        const cvCount = state.cv[type] || 0;
        const cfCount = state.cf[type] || 0;
        cr += `- ${type.charAt(0).toUpperCase() + type.slice(1)}: ${vCount} / ${cvCount} CV / ${cfCount} CF\n`;
      });

      const totalVehicules = typesAAfficher.reduce((a,t) => a + (state.vehicules[t]||0), 0);
      const totalPersonnes = typesAAfficher.reduce((a,t) => a + (state.cv[t]||0) + (state.cf[t]||0), 0);

      cr += `\nTOTAL MOYENS : ${totalVehicules}\n`;
      cr += `TOTAL PERSONNES : ${totalPersonnes}\n`;

      cr += `\n2 - ESI INTERCEPTÉ(S): ${ (state.esiList || []).length }\n`;
      (state.esiList || []).forEach((esi,i) => {
        cr += `ESI ${i+1} - ${esi.heure} - ${esi.age} - ${esi.sexe} - ${esi.ageNum} ans - ${esi.nationalite} - ${esi.lieu} - ${esi.suites}\n`;
      });

      cr += `\n3 - PASSEUR(S) INTERCEPTÉ(S): ${ (state.passeurList || []).length }\n`;
      (state.passeurList || []).forEach((passeur,i) => {
        cr += `PASSEUR ${i+1} - ${passeur.heure} - ${passeur.age} - ${passeur.sexe} - ${passeur.ageNum} ans - ${passeur.nationalite} - ${passeur.lieu} - ${passeur.suites}\n`;
      });

      cr += `\n4 - OBSERVATIONS\n${state.observations ? state.observations.trim() : '(Aucune)'}\n`;
      cr += `\n5 - DÉROULEMENT DE LA MISSION\n${state.deroulement ? state.deroulement.trim() : '(Aucun détail)'}\n`;
      if(state.pulsar === 'oui') cr += `\n6 - PULSAR fait\n`;
      else if(state.pulsar === 'non') cr += `\n6 - PULSAR non fait\n`;
      else cr += `\n6 - PULSAR (non renseigné)\n`;

      document.getElementById('compteRendu').value = cr;
    }

    // Copier
    function copyToClipboard() {
      const textarea = document.getElementById('compteRendu');
      if(!textarea.value) { alert('Générez d’abord le compte rendu.'); return; }
      try {
        navigator.clipboard.writeText(textarea.value).then(()=> alert('Compte rendu copié dans le presse-papiers !')).catch(()=> fallbackCopy(textarea));
      } catch {
        fallbackCopy(textarea);
      }
    }
    function fallbackCopy(textarea) {
      try {
        textarea.select();
        document.execCommand('copy');
        alert('Compte rendu copié dans le presse-papiers !');
      } catch {
        alert('Impossible de copier. Sélectionnez manuellement le texte.');
      }
    }

    // Reset
    function resetData() {
      if(confirm('Voulez-vous vraiment effacer toutes les données sauvegardées ?')) {
        localStorage.removeItem('crGendarmerie');
        location.reload();
      }
    }

    function onGeneralChange() {
      state.site = document.getElementById('siteSelect').value;
      state.date = document.getElementById('dateInput').value;
      state.heureDebut = document.getElementById('heureDebutInput').value;
      state.heureFin = document.getElementById('heureFinInput').value;
      debounceSave();
    }
    function onMaterielChange() {
      state.cameraNum = document.getElementById('cameraNum').value.trim();
      state.cameraESR = document.getElementById('cameraESR').value;
      state.tablette1Num = document.getElementById('tablette1Num').value.trim();
      state.tablette1ESR = document.getElementById('tablette1ESR').value;
      state.tablette2Num = document.getElementById('tablette2Num').value.trim();
      state.tablette2ESR = document.getElementById('tablette2ESR').value;
      state.vehiculeService = document.getElementById('vehiculeService').value.trim();
      debounceSave();
    }
    function onTextAreaChange() {
      state.observations = document.getElementById('observations').value;
      state.deroulement = document.getElementById('deroulement').value;
      debounceSave();
    }

    function onPulsarChange() {
      if(document.getElementById('pulsarOui') && document.getElementById('pulsarOui').checked) state.pulsar = 'oui';
      else if(document.getElementById('pulsarNon') && document.getElementById('pulsarNon').checked) state.pulsar = 'non';
      else state.pulsar = '';
      debounceSave();
    }

    // QR features (kept as in original)
    state.scannedNigends = state.scannedNigends || [];
    state.scansAgg = state.scansAgg || {train:{v:0,cv:0,cf:0}, bus:{v:0,cv:0,cf:0}, vl:{v:0,cv:0,cf:0}, pl:{v:0,cv:0,cf:0}};
    state.resumeEsr = state.resumeEsr || '';

    let html5QrCode = null;
    let isScanning = false;

    window.closeQrModal = function() {
      if(html5QrCode && isScanning){
        html5QrCode.stop().then(() => { isScanning = false; }).catch(() => {});
      }
      document.getElementById('qrModal').style.display = 'none';
    };

    function openQrModal() {
      document.getElementById('qrModal').style.display = 'flex';
      if (!html5QrCode) html5QrCode = new Html5Qrcode("qr-reader");
      html5QrCode.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: 250 },
        onScanSuccess,
        (err) => { console.error("Erreur scan :", err); }
      );
      isScanning = true;
    }

    function closeQrModal() {
      if (html5QrCode && isScanning) {
        html5QrCode.stop().then(()=>{ isScanning=false; }).catch(()=>{});
      }
      document.getElementById('qrModal').style.display = 'none';
    }

    function onScanSuccess(decodedText) {
      try {
        const parsed = parseQrPayload(decodedText);
        if (!parsed) return;
        const { nigend, counts, pretty } = parsed;
        if (state.scannedNigends.includes(nigend)) {
          logScan('NIGEND ' + nigend + ' déjà scanné, ignoré.');
          return;
        }
        state.scannedNigends.push(nigend);
        ['train','bus','vl','pl'].forEach(k=>{
          state.scansAgg[k].v  += counts[k].v;
          state.scansAgg[k].cv += counts[k].cv;
          state.scansAgg[k].cf += counts[k].cf;
        });
        const dejaEsr = (state.esrList || []).some(e => e.nigend === parsed.nigend);
        if (!dejaEsr && parsed.grade && parsed.nom && parsed.nigend && parsed.crt) {
          state.esrList.push({
            grade: parsed.grade,
            nom: parsed.nom,
            nigend: parsed.nigend,
            crt: parsed.crt
          });
          renderEsrList();
          populateEsrSelects();
          debounceSave();
        }
        state.resumeEsr += `NIGEND ${nigend}\n${pretty}\n\n`;
        updateResumeEsrUI();
        debounceSave();
        logScan('QR ajouté : ' + nigend);

        // pause 2s then resume
        if (html5QrCode && isScanning) {
          isScanning = false;
          html5QrCode.stop().then(() => {
            setTimeout(() => {
              if (document.getElementById('qrModal').style.display !== 'none') {
                html5QrCode.start(
                  { facingMode: "environment" },
                  { fps: 10, qrbox: 250 },
                  onScanSuccess
                ).then(()=>{ isScanning=true; }).catch(()=>{});
              }
            }, 2000);
          }).catch(()=>{});
        }
      } catch(e) {
        console.error(e);
      }
    }

    function parseQrPayload(raw){
      const lines = String(raw).split(/\n+/).map(l=>l.trim()).filter(Boolean);
      let nigend='', grade='', nom='', crt='';
      const counts={train:{v:0,cv:0,cf:0}, bus:{v:0,cv:0,cf:0}, vl:{v:0,cv:0,cf:0}, pl:{v:0,cv:0,cf:0}};
      lines.forEach(l=>{
        if(/^NIGEND/i.test(l)) nigend = (l.split(':')[1]||'').trim();
        else if(/^GRADE/i.test(l)) grade = (l.split(':')[1]||'').trim();
        else if(/^NOM/i.test(l)) nom = (l.split(':')[1]||'').trim();
        else if(/^CRT/i.test(l)) crt = (l.split(':')[1]||'').trim();
        const m = l.match(/^(Train|Bus|Vl|Pl)\s*:\s*(\d+)\s*\/\s*(\d+)\s*CV\s*\/\s*(\d+)\s*CF/i);
        if(m){ const key=m[1].toLowerCase(); counts[key].v+=+m[2]; counts[key].cv+=+m[3]; counts[key].cf+=+m[4]; }
      });
      const pretty = `Train: ${counts.train.v} / ${counts.train.cv} CV / ${counts.train.cf} CF
Bus: ${counts.bus.v} / ${counts.bus.cv} CV / ${counts.bus.cf} CF
Vl: ${counts.vl.v} / ${counts.vl.cv} CV / ${counts.vl.cf} CF
Pl: ${counts.pl.v} / ${counts.pl.cv} CV / ${counts.pl.cf} CF`;
      return {nigend, grade, nom, crt, counts, pretty};
    }

    function logScan(msg){
      const div=document.getElementById('scanLog');
      const p=document.createElement('div');
      p.textContent=msg; div.prepend(p);
    }

    function updateResumeEsrUI(){
      document.getElementById('resumeEsr').value=state.resumeEsr || '';
      document.getElementById('nbScans').textContent=(state.scannedNigends||[]).length;
      document.getElementById('nigendList').textContent=(state.scannedNigends||[]).join(', ')||'—';
    }

    // patch generate to include scans
    const oldGenerate = generateCompteRendu;
    generateCompteRendu = function(){
      oldGenerate();
      let totalVeh = 0, totalPers = 0;
      const lines = [];
      ['train','bus','vl','pl'].forEach(type=>{
        const v  = (state.vehicules[type] || 0) + (state.scansAgg[type]?.v || 0);
        const cv = (state.cv[type] || 0) + (state.scansAgg[type]?.cv || 0);
        const cf = (state.cf[type] || 0) + (state.scansAgg[type]?.cf || 0);
        totalVeh  += v;
        totalPers += cv + cf;
        lines.push(`- ${type.charAt(0).toUpperCase() + type.slice(1)}: ${v} / ${cv} CV / ${cf} CF`);
      });
      let cr = document.getElementById('compteRendu').value || '';
      const regex = /1 - MOYENS \/ PERSONNES:[\s\S]*?TOTAL MOYENS :.*\nTOTAL PERSONNES :.*\n/;
      const newSection = `1 - MOYENS / PERSONNES:\n${lines.join('\n')}\n\nTOTAL MOYENS : ${totalVeh}\nTOTAL PERSONNES : ${totalPers}\n`;
      if(regex.test(cr)) cr = cr.replace(regex, newSection);
      else cr += "\n" + newSection;
      document.getElementById('compteRendu').value = cr;
    };

    // init & events
    document.addEventListener('DOMContentLoaded', ()=>{
      document.getElementById('scanQrBtn').addEventListener('click', openQrModal);
    });

    function init() {
      loadFromStorage();
      updateUI();

      // bind events
      document.getElementById('addEsrBtn').addEventListener('click', addEsr);
      document.getElementById('delEsrBtn').addEventListener('click', delEsr);
      document.getElementById('addEsiBtn').addEventListener('click', addEsi);
      document.getElementById('delEsiBtn').addEventListener('click', delEsi);
      document.getElementById('addPasseurBtn').addEventListener('click', addPasseur);
      document.getElementById('delPasseurBtn').addEventListener('click', delPasseur);

      document.querySelectorAll('button.plusminus').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const t = e.target;
          changeCount(t.dataset.type, t.dataset.field, t.dataset.action);
        });
      });

      document.getElementById('trainCvAddManualBtn').addEventListener('click', () => addManualCv('train'));
      document.getElementById('busCvAddManualBtn').addEventListener('click', () => addManualCv('bus'));
      document.getElementById('vlCvAddManualBtn').addEventListener('click', () => addManualCv('vl'));
      document.getElementById('plCvAddManualBtn').addEventListener('click', () => addManualCv('pl'));
      document.getElementById('trainCfAddManualBtn').addEventListener('click', () => addManualCf('train'));
      document.getElementById('busCfAddManualBtn').addEventListener('click', () => addManualCf('bus'));
      document.getElementById('vlCfAddManualBtn').addEventListener('click', () => addManualCf('vl'));
      document.getElementById('plCfAddManualBtn').addEventListener('click', () => addManualCf('pl'));

      ['dateInput','heureDebutInput','heureFinInput'].forEach(id => {
        document.getElementById(id).addEventListener('input', onGeneralChange);
      });
      document.getElementById('siteSelect').addEventListener('input', () => { onGeneralChange(); updateUI(); });

      ['cameraNum','cameraESR','tablette1Num','tablette1ESR','tablette2Num','tablette2ESR','vehiculeService'].forEach(id => {
        const el=document.getElementById(id);
        if(el) el.addEventListener('input', onMaterielChange);
      });

      ['observations','deroulement'].forEach(id => {
        const el=document.getElementById(id);
        if(el) el.addEventListener('input', onTextAreaChange);
      });

      document.getElementById('generateBtn').addEventListener('click', generateCompteRendu);
      document.getElementById('copyBtn').addEventListener('click', copyToClipboard);
      document.getElementById('resetBtn').addEventListener('click', resetData);

      const pulsarOui = document.getElementById('pulsarOui');
      const pulsarNon = document.getElementById('pulsarNon');
      if(pulsarOui) pulsarOui.addEventListener('change', onPulsarChange);
      if(pulsarNon) pulsarNon.addEventListener('change', onPulsarChange);
    }

    init();
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('sw.js').then(()=>console.log("Service Worker enregistré")).catch(err=>console.error("Erreur SW:",err));
    }
  })();
</script>

</body>

</html>

